/*!
* Data Aquarium Framework - Charts for Touch UI
* Copyright 2008-2018 Code On Time LLC; Licensed MIT; http://codeontime.com/license
*/
(function(){function s(n){return n.match(/pie|donut/i)}function n(n,t,i,r){i||(i="visualization");r||(r="1");var f=i+r+(typeof n=="string"?n:n.join("-")),u=c[f];u&&u.loaded?t():u&&!u.loaded?u.callbacks.push(t):($app.touch.busyIndicator(!0),u=c[f]={loaded:!1,callbacks:[t]},google.charts.load("current",{packages:[n],mapsApiKey:$app.touch.mapsApiKey(),callback:function(){$app.touch.busyIndicator(!1);u.loaded=!0;$(u.callbacks).each(function(){this()})}}))}function l(t,i){var u=$('<div class="app-chart-headerbar"><\/div>').appendTo(i),e=$('<div class="app-chart-mini"><\/div>').appendTo(u).attr("title",r.ShowChart),o=t.Properties.title||t.Title,l=$('<span class="app-chart-header"><\/span>').appendTo(u),f=$('<div class="app-chart-data app-scrollable"><\/div>').appendTo(i),s=$("<table><\/table>").appendTo(f),c=!t.ChartType.match(/map|table/);c||e.hide();i.closest(".app-chart").addClass("app-chart-has-data");t.ShowData=!0;n("corechart",function(){var r=google.visualization.arrayToDataTable(t.ChartData),p=r.getNumberOfRows(),y=r.getNumberOfColumns(),v=$("<tr><\/tr>").appendTo(s),u,i,n,f;for(l.text(o.substring(0,1).toUpperCase()+o.substring(1)),a(t,r),i=0;i<y;i++)n=r.getColumnLabel(i),f=$("<th><\/th>").appendTo(v),n!=null&&f.text(n).attr("title",n);for(u=0;u<p;u++)for(v=$("<tr><\/tr>").appendTo(s),i=0;i<y;i++)n=r.getFormattedValue(u,i),f=$("<td><\/td>").appendTo(v),n!=null&&f.text(n=="0"?"":n).attr("title",n);c&&h(t,e)});f.height(Math.floor(i.height()-u.outerHeight(!0)));f.width(i.width())}function h(n,t){var i=v[n.ChartType];i&&i(n,t)}function t(n,t,i){var u=s(n.ChartType),h=n.Properties.title||n.Title,e,r,f,o;i||(i={});i.legend||(i.legend={});i.hAxis||(i.hAxis={});i.vAxis||(i.vAxis={});i.chartArea||(i.chartArea={});i.tooltip||(i.tooltip={});i.title=h.charAt(0).toUpperCase()+h.slice(1);i.width=Math.floor(t.width())-1;i.height=Math.floor(t.height())-1;i.tooltip.trigger="focus";n.ChartData[0].length<=2&&(u||(i.legend.position="none"),u&&(n.Properties.maximize=!0));u&&(i.sliceVisibilityThreshold=0);for(e in n.Properties)if(n.Properties.hasOwnProperty(e)){r=n.Properties[e];switch(e){case"crosshair":i.crosshair={orientation:r==0?"both":r,trigger:"both"};break;case"maximize":u?(i.chartArea.top="15%",i.chartArea.width="80%",i.chartArea.height="80%"):(i.titlePosition="in",i.chartArea.width="100%",i.chartArea.height="100%",i.legend.position||(i.legend.position="in"));i.axisTitlesPosition="in";i.hAxis.textPosition="in";i.vAxis.textPosition="in";break;case"haxistitle":i.hAxis.title=r;break;case"vaxistitle":i.vAxis.title=r;break;case"haxisformat":i.hAxis.format=r;break;case"vaxisformat":i.vAxis.format=r;break;case"region":i.region=r;break;case"displaymode":i.displayMode=r;break;case"resolution":i.resolution=r;break;case"curve":i.curveType="function";break;case"explorer":i.explorer={};break;case"maptype":i.mapType=r;break;case"enablescrollwheel":i.enableScrollWheel=!0;break;case"usemaptypecontrol":i.useMapTypeControl=!0;break;case"pointshape":i.pointShape=r;break;case"pointsize":i.pointSize=r;break;case"orientation":i.orientation=r;break;case"animation":i.animation={startup:!0,duration:500,easing:"out"};break;case"colors":f=r.split(",");for(o in f)f[o]=f[o].trim();i.colors=f}}return n.ShowData&&(i.legend.position="none",i.axisTitlesPosition="none",i.height="100%",i.titlePosition="none",i.chartArea.top="0",i.chartArea.width="100%",i.chartArea.height="100%",i.enableInteractivity=!1),$("body").hasClass("app-theme-dark")&&(i.backgroundColor="#111",i.hAxis.textStyle={color:"white"},i.hAxis.gridlines={color:"#333"},i.vAxis.textStyle={color:"white"},i.vAxis.gridlines={color:"#333"},i.legend.textStyle={color:"#999"},i.legend.scrollArrows={activeColor:"#fff",inactiveColor:"#777"},i.legend.pagingTextStyle={color:"#999"},i.titleTextStyle={color:"white"},u&&(i.pieSliceBorderColor="#111")),i}function a(n,t){var o=n.ValueFieldNames.length,r;for(name in n.Formats){var i=n.Formats[name],u=/(\w+)(\d)/.exec(name),s=u[1],h=u[2],f=n.ValueFieldNames.indexOf(s,h),e;if(f!=-1&&i){switch(i.toLowerCase()){case"c":i="Â¤00.00";break;case"d":i="00.00";break;case"e":i="0.######E+000";break;case"f":i="00.00";break;case"n":i="00.00";break;case"p":i="%";break;case"x":i="00.00"}for(e=new google.visualization.NumberFormat({pattern:i}),r=f+1;r<n.Data[0].length;r=r+o)e.format(t,r)}}}function i(n,t,i,r){function o(){}var f=google.visualization.arrayToDataTable(n.ChartData),e=n.ChartType.match(/geo/i);a(n,f);u.desktop()||e||o();n.Properties.animation&&!e&&n.ChartType!="map"&&i.draw(null,r);i.draw(f,r);u.desktop()&&!e&&(google.visualization.events.addListener(i,"select",function(){if(r.tooltip.trigger=="focus"){r.tooltip.trigger="selection";var n=i.getSelection();return o(),i.draw(f,r),i.setSelection(n),!1}}),google.visualization.events.addListener(i,"click",function(n){n.targetID.match(/^action/)||r.tooltip.trigger!="selection"||(r.tooltip.trigger="focus",i.removeAction("filter"),i.removeAction("exclude"),i.setSelection(null),i.draw(f,r))}))}var y=$(window),p=$.mobile,f,u=$app.touch,c={},r=Web.DataViewResources.Presenters.Charts,e=Web.DataViewResources.Mobile,o,v;$(document).on("resizing.app",function(){$.mobile.activePage.find(".app-chart-inner").children().hide()}).on("searching.app",function(n){var t=n.dataView._id;$("#"+t+'.ui-page .app-wrapper > [data-presenter="Charts"] .app-chart-inner, .app-echo[data-for="'+t+'"] .app-chart-inner').children().hide()}).on("vclick",".app-chart",function(n){function b(){delete o.ShowData;i.viewProp("chartsConfig",a);var r=t.closest(".app-chart-list").parent().data("pivots")["pivot"+w],n=t.closest(".app-chart").find(".app-chart-inner");n.empty();n.closest(".app-chart").removeClass("app-chart-has-data");r.ShowData=!1;h(r,n)}var t=$(n.target),k=t.closest(".app-echo"),i=k.length?$app.find(k.attr("data-for")):u.dataView(),c=t.closest(".app-chart").data("data-context");if(i&&c){var w=c.Id,a=i.viewProp("chartsConfig"),o=a&&a[w],y=f.is(".app-has-sidebar-left")&&!f.is(".app-has-minisidebar-left"),p=$(window).width()/parseFloat(f.css("font-size")),d=y&&p>=50||!y&&p>=40,g=y&&p>=85||!y&&p>=62,v=o.size?o.size:"small",s=[];return t.is(".app-btn-more")&&!$app.mobile.busy()?($app.mobile.callWithFeedback(t.closest(".ui-btn"),function(){v!="large"||g||(v="medium");v!="medium"||d||(v="small");var n=t.closest(".app-chart-list").parent().data("pivots")["pivot"+w];n.ChartType.match(/map|table/)||(o.ShowData?s.push({text:r.ShowChart,icon:"chart",callback:b}):s.push({text:r.ShowData,icon:"grid",callback:function(){o.ShowData=!0;i.viewProp("chartsConfig",a);var r=t.closest(".app-chart").find(".app-chart-inner");r.empty();l(n,r)}}));t.closest(".app-chart-list").find(".app-chart").length>1?(s.push({text:r.Sizes.Label}),s.push({text:r.Sizes.Small,icon:v=="small"?"check":"",callback:function(){delete o.size;o.resized=!0;i.viewProp("chartsConfig",a);$app.touch.presenter("show",{name:"Charts",id:i._id,container:t.closest(".app-wrapper")})}}),d&&s.push({text:r.Sizes.Medium,icon:v=="medium"?"check":"",callback:function(){o.size="medium";o.resized=!0;i.viewProp("chartsConfig",a);$app.touch.presenter("show",{name:"Charts",id:i._id,container:t.closest(".app-wrapper")})}}),g&&s.push({text:r.Sizes.Large,icon:v=="large"?"check":"",callback:function(){o.size="large";o.resized=!0;i.viewProp("chartsConfig",a);$app.touch.presenter("show",{name:"Charts",id:i._id,container:t.closest(".app-wrapper")})}})):s.push({text:r.Sizes.Auto,icon:"check",callback:function(){}});s.push({text:e.Filter});c.ColumnFieldNames&&c.ColumnFieldNames.length&&s.push({text:i.findField(c.ColumnFieldNames[0]).HeaderText,icon:"material-icon-filter-list",callback:function(){u.configureFilter({field:c.ColumnFieldNames[0],scope:i._id,mode:"field"})}});c.RowFieldNames&&c.RowFieldNames.length&&s.push({text:i.findField(c.RowFieldNames[0]).HeaderText,icon:"material-icon-filter-list",callback:function(){u.configureFilter({field:c.RowFieldNames[0],scope:i._id,mode:"field"})}});u.listPopup({anchor:t.closest("a"),iconPos:"right",items:s})}),!1):t.closest(".app-chart-mini").length?(b(),!1):void 0}}).on("taphold",".app-chart",function(n){var t=$(n.target);t.is("td")&&t.closest(".app-chart-data").length&&u.listPopup({anchor:t,title:t.text()})});v={area:function(r,u){n("corechart",function(){var n=t(r,u),f=new google.visualization.AreaChart($(u).get(0));i(r,u,f,n)})},areastacked:function(r,u){n("corechart",function(){var n=t(r,u,{isStacked:!0}),f=new google.visualization.AreaChart($(u).get(0));i(r,u,f,n)})},bar:function(r,u){n("corechart",function(){var n=t(r,u),f=new google.visualization.BarChart($(u).get(0));i(r,u,f,n)})},barstacked:function(r,u){n("corechart",function(){var n=t(r,u,{isStacked:!0}),f=new google.visualization.BarChart($(u).get(0));i(r,u,f,n)})},column:function(r,u){n("corechart",function(){var n=t(r,u),f=new google.visualization.ColumnChart($(u).get(0));i(r,u,f,n)})},columnstacked:function(r,u){n("corechart",function(){var n=t(r,u,{isStacked:!0}),f=new google.visualization.ColumnChart($(u).get(0));i(r,u,f,n)})},candlestick:function(r,u){n("corechart",function(){var n=t(r,u),f=new google.visualization.CandlestickChart($(u).get(0));i(r,u,f,n)})},donut:function(r,u){n("corechart",function(){var n=t(r,u,{pieHole:.4,backgroundColor:"transparent"}),f=new google.visualization.PieChart($(u).get(0));i(r,u,f,n)})},geo:function(r,u){n("geochart",function(){var n=t(r,u,{backgroundColor:"transparent"}),f=new google.visualization.GeoChart($(u).get(0));i(r,u,f,n)})},map:function(r,u){n("map",function(){var n=t(r,u,{showTip:!0}),f=new google.visualization.Map($(u).get(0));i(r,u,f,n)})},line:function(r,u){n("corechart",function(){var n=t(r,u,{showTip:!0}),f=new google.visualization.LineChart($(u).get(0));i(r,u,f,n)})},pie:function(r,u){n("corechart",function(){var n=t(r,u,{title:r.Title,backgroundColor:"transparent"}),f=new google.visualization.PieChart($(u).get(0));i(r,u,f,n)})},pie3d:function(r,u){n("corechart",function(){var n=t(r,u,{backgroundColor:"transparent",is3D:!0}),f=new google.visualization.PieChart($(u).get(0));i(r,u,f,n)})},scatter:function(r,u){n("corechart",function(){var n=t(r,u),f=new google.visualization.ScatterChart($(u).get(0));i(r,u,f,n)})},table:function(r,u){n("table",function(){var n=t(r,u),f=new google.visualization.Table($(u).get(0));i(r,u,f,n)})}};$app.touch.presenter("register",{name:"Charts",icon:function(){return"chart"},text:function(){return r.Text},supports:function(n){var u=!1;if($(n._fields).each(function(){if(this.Tag&&this.Tag.indexOf("pivot")!=-1)return u=!0,!1}),u)n.AutoPivots=null;else{if(n.AutoPivots&&$.isEmptyObject(n.AutoPivots))return!0;n.AutoPivots={};var t=1,g=n._fields[0].Label,i=[],e=0,v=0,h=["pie3d","column","donut","bar"],r=[],f=0,y=0,c=["line","column","area"],p=0,l=["columnstacked-top5","area-top7","column-top5","barstacked-top5"],w=[],a=n.groupExpression(),b=!1,o=function(){return h[v++%h.length]},k=function(){return c[y++%c.length]},d=function(){return l[p++%l.length]};$(n._fields).each(function(){var u=this;n.AutoPivots[u.Name]=[];(u.ItemsDataController||u.AliasName)&&i.push(u.Name);u.Type=="DateTime"&&r.push(u.Name);u.DataFormatString=="c"&&w.push(u.Name);a&&a[0]==(u.AliasName||u.Name)&&n.AutoPivots[u.Name].push("pivot"+t+++"-row1-top10-sortdescbyvalue-"+(u.Type=="String"?"pie-other":"column"))});$(i).each(function(){if(t>9||!r[f])return!1;var u=this,o=r[f];n.AutoPivots[i[e++%i.length]].push("pivot"+t+"-col1-sortdescbyvalue-"+d());n.AutoPivots[r[f++%r.length]].push("pivot"+t+++"-row1-date-all-hideblank")});e=0;f=0;$(n._fields).each(function(){var u,r,f,h;if(t>9)return!1;if(u=this,r=u.Name,u.IsPrimaryKey)return!0;(u.ItemsDataController||u.AliasName)&&n.AutoPivots[r].push("pivot"+t+++"-row1-top10-other-sortdescbyvalue-"+o());switch(u.Type){case"Int16":case"Int32":case"Int64":case"Single":case"Double":case"Decimal":if(i.length!=0&&!(u.ItemsDataController||u.AliasName)){if(f="sum",h=o(),r.match(/salary/i))f="avg";else if(r.match(/total/i))f="sum";else if(u.DataFormatString=="{0:c}"||r.match(/price|discount/i))for(f="avg";s(h);)h=o();s(h)&&(f="sum");n.AutoPivots[r].push("pivot"+t+"-val1-"+f+"-"+h);n.AutoPivots[i[e++%i.length]].push("pivot"+t+++"-row1-top7-other-sortdescbyvalue")}break;case"DateTime":r.match(/birth|hire/i)?n.AutoPivots[r].push("pivot"+t+++"-row1-month-all-pie3d"):n.AutoPivots[r].push("pivot"+t+++"-row1-"+k()+"-date-all-hideblank");break;case"String":b||r.match(/country/i)&&n.AutoPivots[r].push("pivot"+t+++"-row1-geo")}});t>1&&(u=!0)}return u},show:function(n){function a(n){var u,f,o,s,h;v();u=$('<ul class="app-listview app-grid"/>').appendTo(i);n?(s=$('<li data-icon="filter" class="ui-last-child"><a href="#app-filter" class="ui-btn ui-icon-filter ui-btn-icon-left"><p/><\/a><\/li>').appendTo(u).find("a"),h=String.format(r.DataWarning,__settings.maxPivotRowCount),s.attr("title",e.Filter).find("p").text(h)):(f=$('<li data-icon="refresh"><a href="#app-refresh" class="ui-btn ui-icon-refresh ui-btn-icon-left"><p/><\/a><\/li>').appendTo(u).find("a"),f.attr("title",Web.DataViewResources.Pager.Refresh).find("p").text(Web.DataViewResources.Data.NoRecords),t._filter&&t._filter.length&&!t.filterIsExternal()&&(o=$('<li data-icon="filter" class="ui-last-child"><a href="#app-clear-filter" class="ui-btn ui-icon-filter ui-btn-icon-left"><p/><\/a><\/li>').appendTo(u).find("a"),o.attr("title",e.ClearFilter).find("p").text(e.ClearFilter)));u.listview()}function v(){i.find(".app-chart").each(function(){$(this).removeData()});i.empty()}function b(n){for(pivot in n)$(n[pivot].Data).each(function(){for(var t=this,n=0;n<t.length;)t[n]=y(t[n]),n++}),n[pivot].Title=y(n[pivot].Title),n[pivot].ChartData=JSON.parse(JSON.stringify(n[pivot].Data)),$(n[pivot].ChartData).each(function(){for(var i=this,t=this,n=0,n=0;n<t.length;n++)t[n]==null&&(t[n]=0)})}function y(n){if(!n||!isNaN(n)||isFinite(n))return n;var i=n.match(/\$(\S+)/g);return $(i).each(function(){var f=this.replace(/\d*/g,""),i=f.replace(/[$\d]*/g,""),u=r.ChartLabels[i];u?(i.match(/Quarter|Week/)&&(u=u.substring(0,1)),n=n.replace(f,u)):i=="CurrentViewLabel"&&(n=n.replace(f,t._view.Label));i=="Other"&&(n.isOther=!0)}),n}function p(){o=="loaded"?w():o!="loading"&&(o="loading",u.registerAPI("Charts",function(){o="loaded";w()}))}function w(){var y,e,f,n,b,nt=[],ut=0,p=i.closest(".app-wrapper"),tt,o=0,g=1,k,ft=i.find(".app-chart"),it,rt,d=!1,ot,w;ft.length>0&&(ot=p.scrollTop(),$(ft).each(function(){var n=$(this);if(n.position().top>0)return c[n.data("data-context").Id].lastScrollPosition=!0,!1}));v();$('<div class="app-chart"><span class="app-chart-inner"/><\/div><div class="app-chart"><span class="app-chart-inner"/><\/div><div class="app-chart"><span class="app-chart-inner"/><\/div>').appendTo(i);k=i.find(".app-chart");$(k[0]).offset().left<$(k[1]).offset().left&&g++;$(k[1]).offset().left<$(k[2]).offset().left&&g++;k.remove();i.empty();for(b in s)if(n=s[b],n.ChartType&&n.RecordCount!=0)d||(n.Properties.medium||n.Properties.large?d=!0:c&&(config=c[n.Id],config&&config.size&&config.size.match(/medium|large/)&&(d=!0))),o++;else continue;o==1&&(d=!0);for(b in s)(n=s[b],placeholder=$('<div class="app-chart"><\/div>').data("data-context",n),inner=$('<span class="app-chart-inner"><\/span>').appendTo(placeholder),moreBtn=$('<a class="ui-btn"><span class="app-btn-more">&nbsp;<\/span><\/a>').appendTo(placeholder).attr("title",r.More),n.ChartType&&n.RecordCount!=0)&&(placeholder.appendTo(i),y||(f=p.height(),tt=p.find(".app-presenter-instruction:visible"),tt.length&&(f-=tt.outerHeight()),f=Math.floor(f),y=inner.width(),e=g==3?o<=3?Math.min(f,y*1.33):Math.min(y*.66,Math.max(f/3,y*.5))-1:g==2?o<=4?Math.max(f/2,y*.5):y*.66:f*.66,d&&o<=3&&(e=f*.5),e>f&&(e=y*.66,e>f&&(e=f)),e=Math.floor(e)),w=e,config=c[n.Id],config||(config=c[n.Id]={}),config.size||(n.Properties.small!=null?delete config.size:n.Properties.medium!=null?config.size="medium":n.Properties.large!=null&&(config.size="large")),config.size&&(config.size=="medium"?(o>2&&(w=e*2+1),placeholder.addClass("app-chart-medium")):config.size=="large"&&(w=f,placeholder.addClass("app-chart-large"))),o==1&&(placeholder.addClass("app-chart-large"),w=f),config.resized?(it=placeholder,delete config.resized):config.lastScrollPosition&&(rt=placeholder,delete config.lastScrollPosition),config.ShowData||n.ChartType=="table"?n.ShowData=!0:n.ShowData&&(n.ShowData=!1),w<150&&(w=150),nt.push(inner.height(w)));if($('<div class="app-clear-fix"><\/div>').appendTo(i),setTimeout(function(){var i;for(b in s)if(n=s[b],n.ChartType&&n.RecordCount!=0){for(i in n.Formats){var f=n.Formats[i],r=i.match(/(\w+)(\d+)/),e=r[1],u=t.findField(e);u.AliasName&&(delete n.Formats[i],n.Formats[u.AliasName+r[2]]=f)}n.ShowData?l(n,$(nt[ut++])):h(n,nt[ut++])}},10),o==0&&a(!1),i.closest(".app-echo").length==0&&$('<div class="app-promo-filler"><\/div>').appendTo(i),t.viewProp("chartsConfig",c),$app.touch.resetPageHeight(),u.syncEmbeddedViews(p),$app.touch.pointer()=="mouse"&&p.trigger("scroll"),o>1&&(it||rt)){var et=it||rt,st=et.outerHeight(),ht=(p.height()-st)/2,ct=et.offset().top-p.offset().top-ht;u.scroll(p,ct)}}f||(f=$("body"));var k=this,t=$app.find(n.id),d=t._filter,i=n.container.find(".app-chart-list"),s=n.container.data("pivots"),c=t.viewProp("chartsConfig")||{};if(i.length==0&&(i=$('<div class="app-chart-list"><\/div>').appendTo(n.container)),(n.reset||s&&t.dataSignature()!=n.container.data("signature"))&&(s=null),t._totalRowCount>__settings.maxPivotRowCount){a(!0);return}s&&s.length!=0?p():(i.find(".app-chart-inner").children().hide(),$app.execute({controller:t._controller,command:"Pivot",pivotDefinitions:t.AutoPivots,view:t._viewId,_filter:t.combinedFilter(),sort:"",tags:t.get_tags(),success:function(i){s=i.Pivots;b(s);n.container.data("signature",t.dataSignature());n.container.data("pivots",s);p()},error:function(n){$app.alert(String.format("{0}\n{1}",n.get_message(),n.get_stackTrace()))}}))},hide:function(){},dispose:function(n){n.container.removeData("pivots signature");n.container.find("app-chart").each(function(){$(this).removeData()})}})})(),function(){function ru(){return navigator.platform.match(/Win\d+|Mac/i)!=null&&(!navigator.maxTouchPoints||navigator.maxTouchPoints==0)}function nt(n){return n&&typeof n!="string"&&!(isNaN(+n)||n<new Date(1753,0)||n>new Date(9999,0))}function tt(n){navigator.vibrate&&(n||(n=50),navigator.vibrate(n))}function d(n){$('<div class="app-clear-fix"><\/div>').appendTo(n)}function uu(){if(!er){var n=new Date;er=setTimeout(function(){cr=setInterval(h,6e4)},(60-n.getSeconds())*1e3)}}function h(t,i,r){var b,f;if(t||!$(".app-calendar.app-has-time-prompt").length){var u=t||new Date,s=e(u),v=$(".app-calendar-time"),o,c=v.find("div.app-current-time"),k=a-a/25,d=u.getTime(),y=u.getMinutes(),g=new Date(u.getFullYear(),u.getMonth(),u.getDate()).getTime(),nt=d-g,l=v.find("li span"),p=u.getMinutes(),w=15e3/a;return i&&y!=0&&(s=":"+y),i?i=="week"?($(".app-calendar").addClass("app-has-time-prompt"),o=vt.activePage.find(".app-calendar-weekview .current-time-line")):o=$(".app-calendar-dayview .current-time-line"):o=$(".app-calendar-weekview .current-time-line, .app-calendar-dayview .current-time-line"),b=nt/864e5,f=k*b,i=="find"?h():c.first().css("top")!=f+"px"&&n.callInAnimationFrame(function(){s!=""&&(l.removeClass("time-hidden"),p<w?l.filter('span[data-cal-hour="'+u.getHours()+'"]').addClass("time-hidden"):p>60-w&&l.filter('span[data-cal-hour="'+(u.getHours()+1)+'"]').addClass("time-hidden"),c.text(s));c.css("top",f);o.css("top",f).data("date",u);r&&r(f)}),f}}function e(n,i,r){if(!n)return"";var u=n.getHours(),f=n.getMinutes(),h=n.getSeconds(),o=t.PMDesignator,s=t.AMDesignator,e=u<12?r?"":s:r?o.substring(0,1):o;return u>12&&(s||o)&&(u=u-12),i&&u<10&&u!=0&&(u="0"+u),u==0&&(u=o||s?12:0),f<10&&(f="0"+f),!r&&e&&(e=" "+e),r&&f=="00"?String.format("{0}{1}",u,e):String.format("{0}:{1}{2}",u,f,e)}function li(t,i,r){for(var f=n.settings("calendar.drag.precision")||15,e=f/60,o=e/2,s=60/f,u=0;u<s;u++)if(r<e*(u+1)-o)return t.setHours(i,f*u);return t.setHours(i,60)}function g(n){return n.getDate()==k.getDate()&&n.getMonth()==dr&&n.getFullYear()==kr}function ai(n,t){return n.getDate()==t.getDate()&&n.getMonth()==t.getMonth()&&n.getFullYear()==t.getFullYear()}function it(n){var t;return n.each(function(){return t=$(this),firstLeft=t.position().left,firstLeft>0||firstLeft*-1<t.width()/2?!1:void 0}),t}function ct(n,t,i,r,u){var f=n.convertFieldValueToString(t,r),e=u&&n.convertFieldValueToString(t,u),o;if(o=r==null?String.format("{0}:<{1}",t.Name,e):u==null?String.format("{0}:>={1}",t.Name,f):String.format("{0}:$between${1}$and${2}",t.Name,f,e),r&&isNaN(r.getTime())||u&&isNaN(u.getTime()))return console&&console.log&&console.log("Error forming date filter: Date is NaN"),[];var h=t.Name,s=i?i.Name:"",c=n.get_filter().filter(function(n){return n.indexOf(h)!==0&&(!s||n.indexOf(s)!==0)});return newFilter=n._combinedFilter([o].concat(c))}function i(n){var r=n.attr("data-cal-year"),t=n.attr("data-cal-month"),i=n.attr("data-cal-day");return new Date(r,t?t:0,i?i:1)}function lt(n,t){var i=n.attr("data-cal-h"),r=n.attr("data-cal-m"),u=n.attr("data-cal-s"),f=n.attr("data-cal-ms");t.setHours(i,r,u,f)}function dt(n,t){n.attr("data-cal-h",t.getHours()).attr("data-cal-m",t.getMinutes()).attr("data-cal-s",t.getSeconds()).attr("data-cal-ms",t.getMilliseconds())}function w(n,t){n.attr("data-cal-year",t.getFullYear()).attr("data-cal-month",t.getMonth()).attr("data-cal-day",t.getDate())}function fu(n){var i={hour:n.getHours(),minute:n.getMinutes(),ampm:""},r=!!t.AMDesignator.length;return r&&(i.ampm=i.hour>=12?t.PMDesignator:t.AMDesignator,i.hour>12&&(i.hour-=12),i.hour==0&&(i.hour=12)),i.hour=i.hour<10?" "+i.hour:i.hour.toString(),i.minute=i.minute<10?"0"+i.minute:i.minute.toString(),i}function vr(n,t,i){var e="",r=new Date(n,t,1),s=o[r.getDay()],h=new Date(n,t+1,1),l=o[h.getDay()],u="",c=0,a=0,f;for(l!=0&&h.setDate(h.getDate()+(6-l)+1),s!=0&&r.setDate(r.getDate()-s);a<42;)if(s=o[r.getDay()],s==0&&(u&&(e+=u+"<\/tr>"),c++,u="<tr>"),u+="<td",f=r.getMonth(),f==t||i?(i&&f!=t?u+=t==11&&f==0||!(t==0&&f==11||f<t)?' class="app-next-month"':' class="app-prev-month"':ot.setHours(0,0,0,0)==r.setHours(0,0,0,0)&&(u+=' class="app-current-day"'),i&&(u+=String.format(' data-cal-year="{0}" data-cal-month="{1}" data-cal-day="{2}"',r.getFullYear(),r.getMonth(),r.getDate())),u+=String.format(">{0}",r.getDate())):u+=">&nbsp;",u+="<\/td>",r.setDate(r.getDate()+1),a++,!i&&r>=h)break;for(e+=u;c<6;)c++,e+="<tr><td>&nbsp;<\/td><td>&nbsp;<\/td><td>&nbsp;<\/td><td>&nbsp;<\/td><td>&nbsp;<\/td><td>&nbsp;<\/td><td>&nbsp;<\/td><\/tr>";return e+""}function rt(n,t){vt.activePage.find(".app-tabs .ui-btn").each(function(){var n=$(this);if(n.attr("data-text")==t.text())return n.trigger("vclick"),!1})}function ut(n,t){var r=n.find(".app-tabs a"),i;return r.each(function(){var n=$(this);if(n.attr("data-text")==t)return i=n,!1}),i}function yi(n){var s=n.get_hasParent(),h=n.get_filterFields(),o=[],i=[],r,u,f,e,t;return $(n._allFields).each(function(){var n=this,l,v;if(n.Tag)for(l=n.Tag.split(" "),v=l.length,t=0;t<v;t++){if(match=rr.exec(l[t]),match!=null){var y=match[1]?parseInt(match[1]):0,a=match[2],p=match[4],c=i[y];if(a=="disabled")break;c||(i[y]=c={});switch(a){case"date":c.date=n;break;default:c[a]=p||n}}rr.lastIndex=0}if((n.ItemsDataController||n.AliasName)&&n.ItemsStyle!="CheckBoxList"&&(s&&n.Name==h||(u?f||(f=n):u=n)),r||n.Type!="String"||(r=n),(n.Type=="DateTime"||n.Type=="Date")&&!n.tagged("calendar-disabled")){for(e||(e=n),t=0;o[t];)t++;o[t]={date:n,name:n.Label}}}),$.isEmptyObject(i)&&(i=o),$(i).each(function(){var t=this,i;!t.text&&r&&(t.text=r);!t.date&&e&&(t.date=e);t.name||(t.name=t.date.Label);u&&!t.color&&(t.color=r&&f&&r==u?f:u);i=t.color?n.viewProp("calendarColorMap-"+t.color.Name):null;t.colorMap=new ir(n,t,i)}),i}function ft(t,i){var f=n.dataView(),u=f&&f.calendar,c=f&&f.extension().viewStyle;t||(t=u.scrollable());var e=t.find('.app-presenter[data-presenter="calendar"]'),o=e.data("cal-header"),h=u.viewClassName(),s=e.find(h);i&&(u.preventNavigate=!0,u.getViewHandler().resize(s,o,null,!0));pt&&pt();u.updateHeader(o);u.loadData(s);r("refresh",{container:n.sidebar().find(".app-calendar-plugin")})}function yr(t){var i=t&&t.get_viewType(t._id),r=n.sidebar();if(!t||i!="Grid"){br(r);return}if(wr(t))i&&i=="Grid"&&(t.calendar&&t.calendar.loadData(t.calendar.getVisibleView()),t.calendarPlugin&&(__settings.bars.left.mini||$.mobile.activePage.is(".app-page-modal")?br(r):t.calendarPlugin.attach(r)));else return}function pr(n,t){return(t-n)/36e5*(a/25)}function wr(t){if(t.calendar)return!0;if(t._keyFields.length>1)return!1;var i=yi(t),r=n.sidebar();return $.isEmptyObject(i)?!1:(t.calendar=new wi(t,i),t.calendarPlugin||(t.calendarPlugin=new tr(t,i)),!0)}function ni(n,t,i,r){n.css({transform:"",opacity:1}).addClass("app-scale");setTimeout(function(){function u(){return clearTimeout(f),n.hide(),i&&i(),t.removeClass("app-scale").show().css({transform:"scale(0.75)",opacity:0}),setTimeout(function(){function n(){t.removeClass("app-scale");r&&r()}f=setTimeout(function(){t.off("transitionend",n)},500);t.addClass("app-scale").one("transitionend",n).css({transform:"scale(1)",opacity:1})}),!1}var f=setTimeout(function(){n.off("transitionend",u);u()},500);n.one("transitionend",u).css({transform:"scale(0.75)",opacity:0})})}function b(n,t){return n.find(String.format('td[data-cal-month="{0}"][data-cal-day="{1}"]:not(.app-day-hidden)',t.getMonth(),t.getDate()))}function ti(n,t){return n.find(String.format('.app-scroll-column > div[data-cal-year="{0}"][data-cal-month="{1}"]',t.getFullYear(),t.getMonth()))}function eu(n,t){var i={NewValue:t};return n._dataView._validateFieldValueFormat(n,i,!0),i.NewValue}function br(t){t||(t=n.sidebar());t.find(".app-calendar-plugin").addClass("app-hide-request")}for(var vi,gt,pi,wi,bi,ki,di,gi,nr,f,r,tr,ir,at=$(window),c=$("body"),ou=c.hasClass("app-ios"),vt=$.mobile,n=$app.touch,s=Web.DataViewResources,ii=s.Pager,l=s.HeaderFilter,u=s.Presenters.Calendar,et=s.Mobile,t=Sys.CultureInfo.CurrentCulture.dateTimeFormat,k=new Date,ot=new Date(k.getFullYear(),k.getMonth(),k.getDate()),kr=k.getFullYear(),dr=k.getMonth(),rr=/calendar(\d+)?-([a-zA-Z]+)(:['"]?([a-zA-Z]+)['"]?)?(\d+)?/g,gr=/^(\d+), (\d+), (\d+)(, (.*))?$/,yt,ur,pt,ri,ui,wt,fr,er,fi,or,sr,hr,ei,cr,bt=500,oi=100,st=66,si=0,a=1060,y={year:2,month:2,week:7,day:1,agenda:1},hi={year:5,month:5,week:21,day:2,agenda:90},nu=30,kt=30,tu=23,lr=5,o=[],ht=[],v,ci,ar='<a class="ui-btn app-month-picker" title="{0}, {1}">{2}, {3}<\/a>',iu='+{0} <span class="app-month-more">'+et.More.toLowerCase()+"<\/span>",p=0;p<7;p++)o[p]=(7+p-t.FirstDayOfWeek)%7,ht[p]=(p+t.FirstDayOfWeek)%7;vi=function(n){this.calendar=n;this.data={day:{},month:{},year:{},agenda:{}}};vi.prototype={select:function(n){var t=this.calendar.mode,u=new Date(n),i,r;if(t=="week")t="day";else if(t=="agenda")return this.data[t][n];return(r=this.data[t][u.getFullYear()],!r)?null:t=="year"?r:(i=r[u.getMonth()],!i)?null:t=="month"?i:i[u.getDate()]},insert:function(n,t){var a=new Date(n),v=this.dataView,y=this.calendar.activeCalendar.date,i=this.calendar.mode,l=i=="week"?7:1,f,c,h,o,e,r,u,s;if(i=="week")i="day";else if(i=="agenda"){n<0&&t.reverse();this.data[i][n]=t;return}switch(i){case"year":this.data[i][n.getFullYear()]={};break;case"month":r=this.data[i][n.getFullYear()];r||(r=this.data[i][n.getFullYear()]={});r[n.getMonth()]={};break;case"day":for(f=new Date(n),p=0;p<l;p++)r=this.data[i][f.getFullYear()],r||(r=this.data[i][f.getFullYear()]={}),u=r[f.getMonth()],u||(u=r[f.getMonth()]={}),u[f.getDate()]={rows:[],count:0},f.setDate(f.getDate()+1)}for(c in t)(h=t[c],o=gr.exec(h[0]),o)&&(e=new Date(o[1],parseInt(o[2])-1,o[3]||o[2]),r=this.data[i][e.getFullYear()],r||(r=this.data[i][e.getFullYear()]={}),u=r[e.getMonth()],u||(u=r[e.getMonth()]={}),s=u[e.getDate()],s||(s=u[e.getDate()]={rows:[],count:0}),i=="year"?s.count=h[1]:($(h[1]).each(function(){this.length==5&&s.rows.push(this)}),s.count+=h[2]))},clear:function(){this.data={day:{},month:{},year:{},agenda:{}}},clearAgenda:function(){this.data.agenda={}}};$(document).on("scrollstart.app",function(n){n.namespace=="app"&&(yt=!0)}).on("scroll.app scrollstop.app resized.app",function(t){var e;if(t.namespace=="app"){yt=!1;var i=n.dataView(),r=i&&i.calendar,s=i&&i.extension().viewStyle(),f=t.type=="resized";if(i&&s=="calendar"&&r){if(e=r.mode.match(/day|week/),f){var h=r.scrollable(),c=h.find('div[data-presenter="calendar"]'),u=c.data("cal-header"),o=r.getVisibleView();e&&(o&&o.removeClass("app-has-current-day"),u&&u.find(".app-week-header ul, .app-day-header ul").css("visibility","hidden"));u.find(".app-tabs").css("visibility",u.width()<768?"hidden":"visible")}clearTimeout(ur);ur=setTimeout(function(){yt||!f&&e||ft(t.relatedTarget,f)},300)}}}).on("more.app",function(t){var y=$(t.target),f=y.closest(".app-echo"),r=f.length?$app.find(f.attr("data-for")):n.dataView(),e=$.mobile.activePage.find(".app-wrapper"),o=e.find(".app-calendar"),p=t.type=="more",w=t.type=="viewselector",s;if(r&&o.length&&o.is(":visible")&&(s=r.extension().viewStyle(),s=="calendar")){var b=r.viewProp("calendarConfig"),i=b.mode,k=e.parent().find(".app-bar-calendar .app-tabs"),h={text:u.Day,icon:i=="day"?"check":!1,callback:rt},c={text:u.Week,icon:i=="week"?"check":!1,callback:rt},l={text:u.Month,icon:i=="month"?"check":!1,callback:rt},a={text:u.Year,icon:i=="year"?"check":!1,callback:rt},v={text:u.Agenda,icon:i=="agenda"?"check":!1,callback:rt};p&&t.panel[0].id=="app-panel-view-options"?t.items.splice(t.items.length,0,{},h,c,l,a,v):w&&k.css("visibility")=="hidden"&&t.items.splice(0,0,h,c,l,a,v,{})}}).on("vclick contextmenu taphold",".app-calendar, .app-bar-calendar",function(r){var ti,ki,st,kt,o,si,dt,nt,it,d,tt,wi,ht;if(v||ci){v=!1;return}var f=$(r.target),fi=r.type,pt=f.closest(".app-echo"),et=pt.length?$app.find(pt.attr("data-for")):n.dataView(),e=et.calendar,w=$.mobile.activePage.find(".app-wrapper"),ct=w.find('.app-presenter[data-presenter="calendar"]'),s=f.closest(".ui-btn"),wt=f.parent(),ni=f.attr("data-cal-hour"),bi,fr=n.lastTouch();if(et&&et.calendar&&(bi=et._lookupInfo,!(f.closest(".app-tabs ul").length>0))){if(s.length||(s=f.find(".ui-btn")),f.is("ul")&&!!wt.attr("data-cal-day"))f=wt;else if(wt.is(".app-event"))f=wt;else if(f.is(".app-tabs"))return!1;if((fi!="taphold"||f.is(".app-event"))&&(fi!="contextmenu"||f.is("td,.app-event")||ni!=null)){if(ti=f.data("data-context"),ki=f.data("data-more-context"),f.is(".dv-load-at-top, .dv-load-at-bottom, .app-btn-next, .app-btn-prev")){var g=e.getBlocks(w),p,nt,bt=pt.length?0:hi[e.mode],c=e.views[e.mode];if(f.is(".dv-load-at-top, .app-btn-prev")){g.length>bt&&(e.mode=="agenda"?c.removeData(w.find(".app-calendar-agendaview"),c.maxPage):g.slice(bt).remove());var ot=g.first(),b,ii=0,nt=Number(ot.data("cal-year")),tt=ot.data("cal-month")!=null?Number(ot.data("cal-month")):1,di=w.scrollTop(),ei=f.outerHeight(!0)-w.find(".app-presenter-instruction").outerHeight(!0),oi=[];for(p=i(ot),st=0;st<y[e.mode];st++){switch(e.mode){case"month":p.setMonth(p.getMonth()-1,1);b=c.drawMonth(p);break;case"year":p.setFullYear(nt-1);nt=p.getFullYear();b=c.drawYear(p);ei+=-6;break;case"agenda":f.text(l.Loading);c.loadData(w.find(".app-calendar-agendaview"),null,c.minPage-1)}b&&(b.insertBefore(ot),ot=b,oi.push(b))}c.resize(e.getVisibleView());$(oi).each(function(){ii+=$(this).outerHeight(!0)});ii&&n.scroll(w,Math.ceil(di+ii+ei))}else{var lt=g.last(),b,nt=Number(lt.data("cal-year")),tt=lt.data("cal-month")!=null?Number(lt.data("cal-month")):1,p=new Date(nt,tt,1);for(g.length>bt&&(e.mode=="agenda"?c.removeData(w.find(".app-calendar-agendaview"),c.minPage):(g.slice(0,g.length-bt).remove(),kt=0,g.each(function(){kt+=$(this).height()}),n.scroll(w,kt-1))),st=0;st<y[e.mode];st++){switch(e.mode){case"month":p.setMonth(p.getMonth()+1,1);b=c.drawMonth(p);break;case"year":p.setFullYear(nt+1);nt=p.getFullYear();b=c.drawYear(p);break;case"agenda":f.text(l.Loading);c.loadData(w.find(".app-calendar-agendaview"),null,c.maxPage+1)}b&&(b.insertAfter(lt),lt=b)}c.resize(e.getVisibleView())}return!1}if(ti)return e.selectEvent(ti,f,r),!1;if(f.is(".app-event-more")){if(!e.hasKeyFields())return!1;o=i(f.closest(".app-calendar-day"));si=f.data("data-more-context");e.showEventList(o,si,f,r)}else if(f.closest(".app-calendar-month-more").length){if(!e.hasKeyFields())return!1;var ai=f.closest(".app-calendar-month-more"),at=f.closest("td"),gi=at.find(".app-event"),vi=[],tt=f.closest(".app-calendar-month"),k=at.attr("data-cal-day"),ri=i(tt);ri.setDate(k);gi.each(function(){var n=$(this),t=n.data("data-context");vi.push(t[0])});function yi(n){n=n.filter(function(n){return vi.indexOf(n[0])==-1});e.showEventList(ri,n,f,r)}ai.addClass("ui-btn-active");n.callWithFeedback(at,function(){ai.removeClass("ui-btn-active");var n=at.data("data-more-context");n?yi(n):e.requestData({mode:"daylist",date:ri,success:function(t){t.Pivots.pivot0&&t.Pivots.pivot0.Data[1]&&(n=t.Pivots.pivot0.Data[1][1],at.data("data-more-context",n),yi(n))}})})}else{if(f.closest(".app-day-header").length)return f.is("ul")?void 0:(dt=ct.find(".app-calendar-dayview"),it=s.closest(".app-day-header"),n.callWithFeedback(s,function(){var r=s.closest("li"),n=i(r),f=n.getFullYear(),o=n.getMonth(),h=n.getDate(),t=e.getBlockByDate(dt,n,"day"),u=parseInt(dt.css("marginLeft"),10)-t.position().left;t.length&&e.views.day._scroll(dt,it,u*-1,null,!0)}),!1);if(f.closest(".app-week-header").length)return f.is("ul")?void 0:(n.callWithFeedback(s,function(){var n=ut(f.closest(".app-bar-calendar"),u.Day),t=i(s.closest("li"));e.navigateDate=t;n&&n.trigger("vclick")}),!1);if(f.is(".ui-btn")||f.closest(".ui-btn").length){if(s.is(".app-calendar-today,.app-calendar-next,.app-calendar-prev"))return n.callWithFeedback(s,function(){if(w.length>0){var t=s.is(".app-calendar-next"),i=s.is(".app-calendar-prev"),n="today";t?n="next":i&&(n="prev");e.scrollView(n)}}),!1;if(s.is(".app-calendar-badge")){var vt=et.viewProp("calendarConfig"),nr=vt.mode,tr=w.parent().find(".app-bar-calendar .app-tabs");tr.css("visibility")=="hidden"?n.callWithFeedback(s,function(){n.listPopup({anchor:s,iconPos:"left",items:e.getSupportedViews(et).map(function(n){return{text:n.text,icon:nr==n.value?"check":!1,callback:rt}})})}):n.callWithFeedback(s,function(){n.listPopup({anchor:s,title:s.attr("data-cal-value")})})}else if(s.is(".app-calendar-month-header")){o=null;it=ct.data("cal-header");d=ut(it,u.Month);switch(e.mode){case"year":nt=f.closest(".app-calendar-year").attr("data-cal-year");tt=f.closest(".app-calendar-month").attr("data-cal-month");o=new Date(nt,tt);break;case"agenda":o=i(s)}if(o)return e.navigateDate=o,n.callWithFeedback(s,function(){d&&d.trigger("vclick")}),!1}else if(s.parent().attr("data-cal-day")||f.is("h2")){if(e.mode=="month"){if(f.is("td"))return;var it=ct.data("cal-header"),tt=f.closest(".app-calendar-month"),d=ut(it,u.Day);return o=i(tt),o.setDate(s.parent().attr("data-cal-day")),e.navigateDate=o,n.callWithFeedback(s,function(){d&&d.trigger("vclick")}),!1}e.mode!="agenda"||pt.length||(o=i(f.closest("li")),o&&(it=ct.data("cal-header"),d=ut(it,u.Day),e.navigateDate=o,n.callWithFeedback(s,function(){d&&d.trigger("vclick")})))}}else if(f.is("td")||f.is("div")&&ni!=null){if(e.mode=="year"){if(f.height()<20&&!ru())f.closest(".app-calendar-month").find(".app-calendar-month-header").trigger("vclick");else{if(k=parseInt(f.text(),10),!k)return;var nt=f.closest(".app-calendar-year").attr("data-cal-year"),tt=f.closest(".app-calendar-month").attr("data-cal-month"),it=ct.data("cal-header"),d=ut(it,u.Day);e.navigateDate=new Date(nt,tt,k);f.addClass("ui-btn-active");n.callWithFeedback(f,function(){d&&d.trigger("vclick");f.removeClass("ui-btn-active")})}return!1}vt=e.activeCalendar;o=null;var ui=e.getActionsByName("New"),ft,er=$(".app-calendar"),gt=!!vt.end,pi=e.mode=="month",yt;if(!ui.length)return;if(pi){if(k=f.attr("data-cal-day"),tt=f.closest("div.app-calendar-month"),!k)return;o=i(tt);o.setDate(k);gt&&(ft=new Date(o),ft.setMinutes(ft.getMinutes()+60))}else{k=f.closest("div.app-calendar-day");var ir=k.find(".app-calendar-eventlist"),rr=r.clientY-f.offset().top,kt=f.height(),ur=rr/kt;o=i(k);li(o,ni,ur);gt&&(ft=new Date(o),ft.setMinutes(ft.getMinutes()+60));yt=e.drawEvent([null,o,ft,null," "],null).removeClass("app-event-color-0").addClass("app-event-new");gt&&yt.height(a/25);wi=h(o,"find");yt.css("top",wi+22).appendTo(ir)}return o?(ui.forEach(function(n){var t=n.callback,i={action:{action:n,argument:n.argument,dataViewId:et._id,row:null}};n.CommandName=n.command;n.callback=function(){$app.newValues=[{name:vt.date.Name,value:o}];gt&&$app.newValues.push({name:vt.end.Name,value:ft});t(i)}}),ht={iconPos:"left",items:ui,title:String.format("{0:"+t.LongDatePattern+"} {0:"+t.ShortTimePattern+"}",o),afterclose:function(){yt&&yt.remove()}},pi?ht.anchor=f:(ht.x=r.pageX,ht.y=r.pageY,ht.arrow="b,t,l,r"),n.listPopup(ht),!1):void 0}}}}}).on("clear.dataview.app",function(n){var t=n.dataView,i=t.calendar;i&&$("#"+t._id).find(".app-calendar-selected").removeClass("app-calendar-selected")}).on("reset.dataview.app",function(t){var i=t.dataView,f,e;if(i){var r=i.calendar,o=i&&i.extension()&&i.extension().viewStyle(),u=i.calendarPlugin;if(r&&(r.clear(),r.activeCalendar.colorMap.clearFilter()),u){if(f=i&&i.get_viewType(i._id),e=i.get_master(),e&&!i.get_selectedKey().length)return;f&&f=="Grid"&&(u.filtering||(u.clearCache(),n.stickyHeaderBar().hide()))}}}).on("pageready.app",function(n){n.dataView&&yr(n.dataView)}).on("sidebarstatechanged.app",function(){yr($app.touch.contextDataView())});gt={options:{dataView:!0},start:function(n){var t,i;if(n.dir="horizontal",t=n.dataView.calendar,i=t.getViewHandler(),this._calendar=t,this._handler=i,i._scroll){var r=t.getVisibleView(),u=r.closest(".app-presenter"),f=u.data("cal-header").find(".app-"+t.mode+"-header");this._calView=r;this._calHeader=f;this._startMarginLeft=parseInt(r.css("margin-left"),10)}this._startX=n.x;this.scrollingAnimationFrame=null},move:function(n){var t=this;if(t._startMarginLeft!=null){var u=n.target,i=n.x-t._startX,r=t._startMarginLeft+i;t.scrollingAnimationCallback=function(){v=!0;t._handler._scroll(t._calView,t._calHeader,-r,null);t.scrollingAnimationCallback!=null&&(t.scrollingAnimationFrame=requestAnimationFrame(t.scrollingAnimationCallback))};t.scrollingAnimationFrame==null&&(t.scrollingAnimationFrame=requestAnimationFrame(t.scrollingAnimationCallback))}},end:function(){this.scrollingAnimationCallback=null},cancel:function(){this.scrollingAnimationCallback=null}};$app.dragMan.calendar=gt;$app.dragMan["calendar-bar-week"]=gt;$app.dragMan["calendar-bar-day"]=gt;pi={options:{dataView:!0},start:function(t){var o;t.dir="all";var s=t.dataView,r=t.target,u=s.calendar,h=u.scrollable(),i=r.closest(".app-event"),c=r.is(".app-event-handle"),f=i.data("data-context"),e=i.position();f&&(this._element=i,this._oldHeight=i.height(!0),this._oldTop=e.top,this._context=f,this._startX=t.x,this._startY=t.y,this._mode="move",this._hasMoved=!1,this._hasScrolled=!1,u.mode.match(/day|week/)?(o=h.find(".app-presenter-instruction"),this._diffY=o.height()-e.top,c&&(this._mode="resize",this._diffY-=r.position().top,v=!0)):this._placeholder=$('<span style="display:none"><\/span>').insertAfter(i));n.stickyHeaderBar().hide().addClass("app-disabled")},move:function(t){var y,st,lt,g,it,k,rt;c.css("pointer-events","");var ut=this,ft=t.dataView,o=ft&&ft.calendar,gt=t.target,s=$(t.dropTarget),ni=this._context[1],r=o.scrollable(),l=this._element;this._hasMoved||(this._hasMoved=!0,this._element.addClass("app-event-preview"));switch(o.mode){case"day":case"week":if(s=s.closest(".app-calendar-day,.current-time-line"),s.length){canDrag=!0;var u=s.is(".current-time-line")?s.data("date"):i(s),vt=t.y-this._startY-this._diffY,yt=a/25,v=vt/yt,et=r.offset();if(!ui){var d=t.x-et.left-60,ot=r.width()-d-60,pt=d<30||ot<30;d<30?o.scrollView("prev"):ot<30&&o.scrollView("next");pt&&(this._hasScrolled=!0,ui=setTimeout(function(){ui=null},1e3))}if(ri||(ri=setTimeout(function(){ri=null;var f=r.scrollTop(),u=t.y-et.top,e=r.height()-u,i;if(u<20){if(i=20-u,f<i)return;ut._diffY+=i;n.scroll(r,r.scrollTop()-i)}else if(e<20){if(i=20+e,f>=r[0].scrollHeight-r.height()-i)return;ut._diffY-=i;n.scroll(r,r.scrollTop()+i)}},20)),v>23.75?v=23.75:v<0&&(v=0),y=Math.floor(v),st=v-y,y!=null&&(li(u,y,st),!this._previewDate||u.getTime()!=this._previewDate.getTime())){var wt=o.mode=="week"?"week":"find",bt=h(u,wt)+22,kt=o.getVisibleView(r),ht=o.getBlockByDate(kt,u);if(ht.length){var f=this._context[1],ct=this._context[2],p=new Date(f),w,b;p.setMinutes(p.getMinutes()+30);this._mode=="resize"?(u.setFullYear(f.getFullYear(),f.getMonth(),f.getDate()),u<p&&(u=p),w=e(f,!1)+" - "+e(u,!1),b=e(f,!1)+" - "+e(u,!1),l.css("height",pr(f.getTime(),u.getTime()))):(w=e(u,!1,!0),b=e(u),ct&&(lt=ct.getTime()-f.getTime(),g=new Date(u.getTime()+lt),w+=" - "+e(g,!1),b+=" - "+e(g,!1)),l.css("top",bt),l.appendTo(ht.find(".app-calendar-eventlist")));l.find(".app-event-time").text(w);l.find(".app-event-time-long").text(b);this._previewDate=u}}}break;case"month":var nt=s.closest("td"),dt=nt.closest(".app-calendar-month"),tt=i(dt),at=nt.attr("data-cal-day");at&&(tt.setDate(at),it=nt.find("ul"),it.length&&(!this._previewDate||tt.getTime()!=this._previewDate.getTime())&&(this._previewDate=tt,l.appendTo(it)));k=t.y-r.position().top;rt=r.height()-k;fi||(fi=setTimeout(function(){fi=null;var t=r.scrollTop();n.desktop()&&(k<20?n.scroll(r,r.scrollTop()-(20-k)):rt<20&&n.scroll(r,r.scrollTop()+(20+rt)))},20));break;case"year":case"agenda":return}},end:function(n){var ut=n.target,u=n.dataView,e=u&&u.calendar,tt=e.scrollable(),p,d,c,w,l,g,b,nt;if(u._keyFields.length){var k=e&&e.activeCalendar,v=this._context,r=v[1],t,y=v[2],f,o=$(n.dropTarget);switch(e.mode){case"day":case"week":if(o=o.closest(".app-calendar-day,.current-time-line"),o.length){t=o.is(".current-time-line")?o.data("date"):i(o);var it=n.y-this._startY-this._diffY,rt=a/25,s=it/rt;s>23.75?s=23.75:s<0&&(s=0);p=Math.floor(s);d=s-p;li(t,p,d);this._mode=="resize"&&(t.setFullYear(r.getFullYear(),r.getMonth(),r.getDate()),f=t,t=r,c=new Date(r),c.setMinutes(c.getMinutes()+30),f<c&&(f=c))}break;case"month":w=$(event.target).closest("td");l=w.closest(".app-calendar-month");l.length&&(t=new Date(r),t.setYear(l.attr("data-cal-year")),t.setMonth(l.attr("data-cal-month")),t.setDate(w.attr("data-cal-day")),t.getDate()==r.getDate()&&t.getMonth()==r.getMonth()&&(t=null));this._placeholder.remove();break;case"year":case"agenda":return}t&&(g=u._keyFields[0].Name,b=[{field:g,value:v[0]},{field:k.date.Name,oldValue:r,newValue:t}],(y||f)&&(f||(nt=y.getTime()-r.getTime(),f=new Date(t.getTime()+nt)),b.push({field:k.end.Name,oldValue:y,newValue:f})),e.preventNavigate=!0,$app.execute({command:"Update",controller:u._controller,view:u._viewId,values:b,success:function(n){n.errors.length>0&&$app.alert(n.errors[0]);e.lastScrollTop=tt.scrollTop();u.sync()},error:function(n){$app.alert(String.format("{0}",n.get_message()))}}));$(".app-calendar").removeClass("app-has-time-prompt");setTimeout(h,oi*2)}},cancel:function(t){var e=t.target,i=this._element,r=t.dataView.calendar,u,f;r.mode!="month"&&Math.abs(t.x-this._startX)<5&&e.trigger("vclick");this._hasMoved&&i.removeClass("app-event-preview");r.mode.match(/day|week/)?(u=r.getBlockByDate(r.getVisibleView(),this._context[1]),u.length?i.appendTo(u.find("ul")):i.remove()):(this._hasMoved&&i.insertAfter(this._placeholder),this._placeholder.remove());$(".app-calendar").removeClass("app-has-time-prompt");setTimeout(h,oi*2);f=this._oldHeight;i.css({height:f,top:this._oldTop});n.stickyHeaderBar().removeClass("app-disabled");r.preventNavigate=!0}};$app.dragMan["calendar-event"]=pi;$app.dragMan["calendar-event-handle"]=pi;wi=function(n,t){var i=this,r=n.viewProp("calendarConfig")||{};i.dataView=n;r.mode||(r.mode=n.tagged("calendar-day")?"day":n.tagged("calendar-week")?"week":n.tagged("calendar-month")?"month":n.tagged("calendar-year")?"year":n.tagged("calendar-agenda")?"agenda":$(document).width()<768?"day":"week");i.mode=r.mode;i.calendars=t;r.activeCalendar&&$(t).each(function(){if(this.name==r.activeCalendar)return i.activeCalendar=this,!1});i.activeCalendar||(i.activeCalendar=t[Object.keys(t)[0]]);i.cache=new vi(i);i.views={day:new bi(i),week:new ki(i),month:new di(i),year:new gi(i),agenda:new nr(i)};n.viewProp("calendarConfig",r)};wi.prototype={scrollable:function(){var t=this,n=t._scrollable;return n||(n=t._scrollable=$("#"+this.dataView._id+" .app-wrapper")),n},viewClassName:function(){return String.format(".app-calendar-{0}view",this.mode)},getSupportedViews:function(n){var t=[];return n.tagged("calendar-day-disabled")||t.push({value:"day",text:u.Day}),n.tagged("calendar-week-disabled")||t.push({value:"week",text:u.Week}),n.tagged("calendar-month-disabled")||t.push({value:"month",text:u.Month}),n.tagged("calendar-year-disabled")||t.push({value:"year",text:u.Year}),n.tagged("calendar-agenda-disabled")||t.push({value:"agenda",text:u.Agenda}),t},show:function(t){var f=this,s=this.dataView,h=t.container.closest(".app-echo").length>0,c=t.container.find(".app-calendar"),a=t.container.closest(".app-wrapper"),k=this.calendars,v=s.viewProp("calendarConfig"),d=this.activeCalendar.colorMap,e,g,l,y,p,o,w,b;if(!$.isEmptyObject(k)){if(!h&&this.lastScrollTop&&a.scrollTop()==0&&n.scroll(a,this.lastScrollTop),h?(this.mode=v.mode="agenda",this.echoMaxHeight=t.maxHeight,s.viewProp("calendarConfig",v)):v.mode&&(this.mode=v.mode),y=this.getViewHandler(),this.navigateDate||this.preventNavigate||(p=s.extension().commandRow(),p&&this.activeCalendar.date&&(this.enhancePrecision=!0,this.navigateDate=p[this.activeCalendar.date.Index]),this.navigateDate||(this.navigateDate=new Date)),c.length>0){if(o=t.container.find(".app-calendar > div:visible"),!h)if(e=t.container.data("cal-header"),y.showHeaderAndFooter(e,null),$app.touch.tabs("fit",{container:e}),$app.touch.bar("show",e),d.show(),o.is(f.viewClassName())){if(this.navigateDate&&!this.preventNavigate){if(l=this.getBlockByDate(o,this.navigateDate),l&&l.length&&!h){this.scroll({view:o,enhancePrecision:!0});return}this.animate=!1}}else o.hide()}else c=$('<div class="app-calendar" data-draggable="calendar"><\/div>').appendTo(t.container),h||(e=$('<div class="app-bar-calendar"><\/div>').appendTo($app.touch.bar("create",{type:"header",page:t.container})),w=$('<div class="app-tabs"><\/div>').appendTo(e),g=$('<div class="app-calendar-badge ui-btn"><\/div>').appendTo(e),$app.touch.tabs("create",{container:w,tabs:f.getSupportedViews(s).map(function(n){return{text:n.text,value:n.value,active:n.value==f.mode}}),change:function(u){var o=f.mode,c=f.getMostVisibleBlock(a,o),e=c&&i(c),h=!1,l=s.viewProp("calendarConfig"),v=s.calendarPlugin;if(l.mode=u.value,s.viewProp("calendarConfig",l),!f.navigateDate){if(f.lastDate)switch(o){case"year":f.lastDate.getFullYear()==e.getFullYear()&&(h=!0);break;case"month":f.lastDate.getFullYear()==e.getFullYear()&&f.lastDate.getMonth()==e.getMonth()&&(h=!0)}f.navigateDate=h?f.lastDate:e;f.enhancePrecision=!0}o.match(/week|day/)&&(f.lastDayScrollTop=a.scrollTop());t.container=t.container.closest(".app-wrapper");t.container.focus();f.navigateDate&&isNaN(f.navigateDate.getTime())&&(alert("navigate date is NaN"),f.navigateDate=new Date);n.presenter("show",t);r("refresh",{container:n.sidebar().find(".app-calendar-plugin")})},restoreScrolling:!1,stickyHeader:!0}),t.container.data("cal-header",e),setTimeout(function(){e.width()<768&&w.css("visibility","hidden")}),$('<a class="ui-btn ui-btn-icon-notext ui-icon-carat-l ui-corner-all app-calendar-prev"><\/a>').attr("title",ii.Previous).appendTo(e),$('<a class="ui-btn ui-btn-icon-notext ui-icon-carat-r ui-corner-all app-calendar-next"><\/a>').attr("title",ii.Next).appendTo(e),b=$('<a class="ui-btn ui-btn-icon-notext ui-icon-calendar ui-corner-all app-calendar-today"><\/a>').attr("title",u.Today),b.appendTo(e),uu());this.activeCalendar.end?c.addClass("app-calendar-has-end-time"):c.removeClass("app-calendar-has-end-time");var nt=String.format("app-calendar-{0}view",this.mode),tt=String.format(".app-{0}-header",this.mode),o=c.find("."+nt),it=h?null:e.find(tt);this.navigateDate&&!this.preventNavigate&&(l=this.getBlockByDate(o,this.navigateDate));o.length>0&&(this.preventNavigate||this.navigateDate&&l&&l.length)?(o.is(":visible")||o.fadeIn("fast"),y.resize(o,it,null)):o=y.draw(c,this.navigateDate);h||($app.touch.bar("show",e),f.updateHeader(e));this.resetVars()}},scroll:function(n){n.view||(n.view=this.getVisibleView());n.preventNavigate==null&&(n.preventNavigate=this.preventNavigate);n.enhancePrecision==null&&(n.enhancePrecision=this.enhancePrecision);n.animate==null&&(n.animate=this.animate);n.date==null&&(n.date=this.navigateDate);this.getViewHandler().scroll(n);this.resetVars()},hide:function(t){var u=n.dataView(),o=u&&u.extension().viewStyle(),i=this.scrollable();if(i&&(this.lastScrollTop=i.scrollTop()),o!="calendar"){var f=t.container.data("cal-header"),e=n.sidebar(),s=e.find(".app-calendar-color-legend"),h=i.find('.app-presenter[data-presenter="calendar"]');f&&$app.touch.bar("hide",f);r("refresh",{container:e.find(".app-calendar-plugin")});this.activeCalendar.colorMap.hide()}},dispose:function(n){var i=n.container.data("cal-header"),t=this.dataView,r;i&&(i.off(),$app.touch.tabs("destroy",{container:i}),$app.touch.bar("remove",i));n.container.removeData();clearInterval(cr);this.cache.clear(n.container);t.calendar.activeCalendar.colorMap.clearFilter();for(r in this.views)this.views[r].calendar=null;t.calendar=null;t.calendarPlugin.calendar=null;t.calendarPlugin.dataView=null;t.calendarPlugin=null;this.dataView=null;this._scrollable=null},selectEvent:function(t,i,r){function p(t){var o=i.is(".app-calendar-selected"),r=n.pageInfo(u._id);v=e=="taphold";s||(r.echoChanged=!0);v||e=="vclick"&&b?(t&&(i.removeClass("app-calendar-selected"),u.extension().clearSelection()),n.refreshEchoToolbarWithDelay(u,f)):e=="contextmenu"?(n.contextScope(u._id),n.rowContext(i,{x:k,y:d}),n.contextScope(null),n.refreshEchoToolbarWithDelay(u,f)):(n.contextScope(u._id),n.executeInContext(),n.contextScope(null))}function w(t){function r(n){var t=n.data("data-context");if(t&&t[h.Name]==y)return n.addClass("app-calendar-selected"),!1}u.extension().tap({row:t},l?"select":"none");c.find(".app-calendar-selected").removeClass("app-calendar-selected");f.find(".app-calendar-selected").removeClass("app-calendar-selected");s?c.find(o.viewClassName()+" .app-event").each(function(){r($(this))}):i.closest(".app-event, .app-calendar-month-more").addClass("app-calendar-selected");f.length&&f.find(".app-event").each(function(){r($(this))});l||(p(!1),n.refreshEchoToolbarWithDelay(u,f))}var e=r.type,b=r.ctrlKey,k=r.pageX,d=r.pageY,c=this.scrollable(),o=this,u=o.dataView,l=u._lookupInfo,s=i.closest(".app-echo").length;if(this.hasKeyFields()){var h=this.dataView._keyFields[0],a=this.getCurrentKey(),y=this.mode!="agenda"&&!s?t[0]:t[h.Name],f=$("#"+u._id+"_echo");if(u._keyFields.length==1){if(ci)return;n.clearHtmlSelection();a!=null&&y==a?p(!0):o.mode=="agenda"?w(t):$app.execute({controller:u._controller,view:u._viewId,filter:[{field:h.Name,operator:"=",value:t[0]}],includeRawResponse:!0,sort:"",success:function(n){ci||w(n.rawResponse.Rows[0])},error:function(n){$app.alert(String.format("{0}",n.get_message()))}});i.addClass("ui-btn-active");n.callWithFeedback(i,function(){i.removeClass("ui-btn-active")})}}},showEventList:function(i,r,u,f){var e=this,s=e.getCurrentKey(),o=[];r.forEach(function(n){var t=n[0],i=n[1],r=n[2],c=n[3],h=n[4];o.push({text:e.getEventTitle(i,r,h,""),color:e.activeCalendar.colorMap.color(n[3]),visible:t==s?!0:!1,callback:function(){e.selectEvent(n,u,f)}})});n.listPopup({title:String.format("{0:"+t.LongDatePattern+"}",i),anchor:u,iconPos:"left",items:o})},getViews:function(){return $("#"+this.dataView._id).find('.app-wrapper .app-presenter[data-presenter="calendar"] > div.app-calendar > div')},getVisibleView:function(){return this.scrollable().find('.app-presenter[data-presenter="calendar"] > div.app-calendar > div.app-calendar-'+this.mode+"view")},getViewHandler:function(){return this.views[this.mode]},resetVars:function(){this.preventNavigate=null;this.lastDate=this.navigateDate;this.navigateDate=null;this.enhancePrecision=null;this.animate=null},clear:function(n){var t=this.getVisibleView(),i;this.cache.clear();for(i in this.views)this.views[i].clear(i==this.mode?n:!1);t&&t.length&&(this.loadData(t),this.dataView.calendarPlugin&&this.dataView.calendarPlugin.clearCache())},drawDayColumns:function(n,t,i){for(var u,f,e="",r=new Date(n.getFullYear(),n.getMonth(),n.getDate()),s=0;s<t;s++)u='<div data-cal-year="'+r.getFullYear()+'" data-cal-month="'+r.getMonth()+'" data-cal-day="'+r.getDate()+'" class="app-calendar-day',g(r)&&(u+=" current-day-column"),o[r.getDay()]==6&&(u+=" endofweek"),u+='">',f="",i&&(f+=this.drawTimeColumn(n)),f+='<div data-cal-hour="0"><\/div><div data-cal-hour="0"><\/div><div data-cal-hour="1"><\/div><div data-cal-hour="2"><\/div><div data-cal-hour="3"><\/div><div data-cal-hour="4"><\/div><div data-cal-hour="5"><\/div><div data-cal-hour="6"><\/div><div data-cal-hour="7"><\/div><div data-cal-hour="8"><\/div><div data-cal-hour="9"><\/div><div data-cal-hour="10"><\/div><div data-cal-hour="11"><\/div><div data-cal-hour="12"><\/div><div data-cal-hour="13"><\/div><div data-cal-hour="14"><\/div><div data-cal-hour="15"><\/div><div data-cal-hour="16"><\/div><div data-cal-hour="17"><\/div><div data-cal-hour="18"><\/div><div data-cal-hour="19"><\/div><div data-cal-hour="20"><\/div><div data-cal-hour="21"><\/div><div data-cal-hour="22"><\/div><div data-cal-hour="23"><\/div><div data-cal-hour="0"><\/div><ul class="app-calendar-eventlist"><\/ul><div class="app-clear-fix"><\/div>',u+=f+"<\/div>",e+=u,r.setDate(r.getDate()+1);return e},drawDayHeaders:function(n,i){for(var u="",r=new Date(n.getFullYear(),n.getMonth(),n.getDate()),f=0;f<i;f++){var e=o[r.getDay()],s=t.DayNames[r.getDay()],h=t.AbbreviatedDayNames[r.getDay()];u+='<li  data-cal-year="'+r.getFullYear()+'" data-cal-month="'+r.getMonth()+'" data-cal-day="'+r.getDate()+'" class="';e==0&&(u+=" first-day-of-week");e==6&&(u+=" last-day-of-week");u+='"><a class="ui-btn" title="'+s+'"><span class="letter-day">'+h.substring(0,1)+'<\/span><span class="abbr-day">'+h+'<\/span><span class="full-day">'+s+"<\/span>&nbsp;<div";g(r)&&(u+=' class="app-current-day"');u+=">"+r.getDate()+"<\/div><\/a><\/li>";r.setDate(r.getDate()+1)}return u},drawTimeColumn:function(){for(var r,f,e='<div class="app-calendar-time"><ul>',i,o=!!t.AMDesignator.length,n=0;n<=24;n++)o?n==12?i=u.Noon:(r=n%12,f=n<12?t.AMDesignator:t.PMDesignator,(n==0||n==24)&&(r=12,f=t.AMDesignator),i=String.format("{0} {1}",r,f)):i=n==24?0:n,e+='<li><span data-cal-hour="'+n+'">'+i+"<\/span><\/li>";return e+'<\/ul><div class="app-current-time"><\/div><\/div>'},getBlocks:function(){return this.getViewHandler().getBlocks()},getMostVisibleBlock:function(n){var t,r,i,u;n||(n=this.scrollable());r=n.height()/2;i=$(this.getBlocks(n));switch(this.mode){case"day":case"week":if(i.each(function(){var n=$(this);if(t||(t=n),n.position().left>n.width()/2)return!1;t=n}),this.mode=="week")while(t&&t.length&&t.position().left+t.width()<=st)u=t.next(),t=u;break;case"year":case"month":case"agenda":i.each(function(){var n=$(this);return t=n,n.offset().top+n.height()>r?!1:void 0})}return t},getFirstVisibleBlock:function(t){var u,f;t||(t=this.scrollable());var e=n.stickyHeaderBar().outerHeight()+t.offset().top,r=$(this.getBlocks(t)),i=r.eq(0),o=i.width(),s=this.getVisibleView(),h=parseInt(s.css("marginLeft"),10);switch(this.mode){case"day":case"week":u=Math.floor(-h/o);i=r.eq(u);i&&i.length&&i.position().left<0&&(f=r.eq(u+1),f.length&&(i=f));break;case"month":case"year":case"agenda":r.each(function(){var n=$(this);if(n.offset().top>e)return!1;i=n})}return i},getLastVisibleBlock:function(n){var t,r=n.height()+n.position().top,u=n.width(),i=$(this.getBlocks(n));switch(this.mode){case"day":case"week":i.each(function(){var n=$(this);if(t||(t=n),n.position().left>=u)return!1;t=n});break;case"month":case"year":case"agenda":i.each(function(){var n=$(this);if(t||(t=n),n.offset().top>r)return!1;t=n})}return t},getBlockByDate:function(n,t){var i=t.getFullYear(),r=t.getMonth(),u=t.getDate();if(!n||!n.length)return null;switch(this.mode){case"year":return n.find(String.format('.app-calendar-year[data-cal-year="{0}"]',i));case"month":return n.find(String.format('.app-calendar-month[data-cal-year="{0}"][data-cal-month="{1}"]',i,r));case"week":case"day":return n.find(String.format('.app-calendar-day[data-cal-year="{0}"][data-cal-month="{1}"][data-cal-day="{2}"]',i,r,u));case"agenda":return n.find(String.format('li[data-cal-year="{0}"][data-cal-month="{1}"][data-cal-day="{2}"] ul',i,r,u))}},resizeScroller:function(){return},updateHeader:function(n){var r=this;ei||(ei=setTimeout(function(){var v=r.scrollable(),at=r.mode,w=n.find(".app-tabs"),ot=w.css("visibility")!="hidden"&&!w.is(":empty"),y=r.getFirstVisibleBlock(v),l,ft,et;if(y){var c=n.find(".app-calendar-badge"),e=i(y),u=e.getFullYearText(),b=e.getMonth(),vt=e.getDay(),o=e.getDate(),s=t.MonthNames[b],h=t.AbbreviatedMonthNames[b],yt=ot?w.find("ul").offset().left-c.offset().left:n.find("a.app-calendar-today").offset().left,st=1,f=[];switch(at){case"year":f=["<b>"+u+"<\/b>&nbsp;"];l=y.find("h1");l.is("app-in-header")||(v.find(".app-calendar-yearview .app-calendar-year h1.app-in-header").removeClass("app-in-header"),l.addClass("app-in-header"));break;case"month":f=[String.format("<b>{0}<\/b> {1}",s,u),String.format("<b>{0}<\/b> {1}",h,u),String.format("<b>{0}<\/b>",s),String.format("<b>{0}<\/b>",h)];l=y.find("h1.app-calendar-month-header");l.is("app-in-header")||(v.find(".app-calendar-monthview .app-calendar-month h1.app-calendar-month-header.app-in-header").removeClass("app-in-header"),l.addClass("app-in-header"));break;case"week":var k=r.getLastVisibleBlock(v),d=k?i(k):new Date,g=d.getFullYearText(),nt=d.getMonth(),a=d.getDate(),p=b==nt,tt=u==g,it=t.MonthNames[nt],rt=t.AbbreviatedMonthNames[nt];if(!k)return;f.push(String.format("<b>{0} {1}<\/b>{2} - <b>{3}{4}<\/b>, {5}",s,o,tt?"":", "+u,p?"":it+" ",a,g),String.format("<b>{0} {1}<\/b>{2} - <b>{3}{4}<\/b>, {5}",h,o,tt?"":", "+u,p?"":rt+" ",a,g));tt?f.push(String.format("<b>{0} {1}<\/b> - {2}{3}",s,o,p?"":it+" ",a),String.format("<b>{0} {1}<\/b> - {2}{3}",h,o,p?"":rt+" ",a),String.format("<b>{0} {1}<\/b>, {2}",s,o,u),String.format("<b>{0} {1}<\/b>, {2}",h,o,u)):f.push(String.format("<b>{0} {1}<\/b>, {2} - <b>{3} {4}<\/b>",s,o,u,it,a),String.format("<b>{0} {1}<\/b>, {2} - <b>{3} {4}<\/b>",h,o,u,rt,a),String.format("<b>{0} {1}<\/b>, {2}",s,o,u),String.format("<b>{0} {1}<\/b>, {2}",h,o,u));break;case"agenda":case"day":var pt=t.DayNames[ht[vt]],wt=new RegExp(pt+"(.?) ","i"),ut=String.format("{0:"+t.MonthDayPattern+"}",e),bt=new RegExp(ut,"i"),ct=String.format("{0:"+t.LongDatePattern+"}",e).replace(bt,"<b>"+ut+"<\/b>"),lt=ct.replace(wt,"");f=[ct,lt,lt.replace(t.MonthGenitiveNames[e.getMonth()],t.AbbreviatedMonthGenitiveNames[e.getMonth()])];e.getFullYear()==(new Date).getFullYear()&&f.push("<b>"+ut+"<\/b>",String.format("<b> {0:"+t.MonthDayPattern.replace(/M+/,"MMM")+"}<\/b>",e));f.push(e.toLocaleDateString())}for(f[0]&&(ft=f[0].replace(/<\/?b>|&nbsp;/g,""),c.html(f[0]).attr("title",ft).attr("data-cal-value",ft));c[0].clientWidth+5>yt;){if(et=f[st],!et)break;c.html(et);st++}ot?c.removeClass("app-has-droparrow"):c.addClass("app-has-droparrow");ei=null}},300))},scrollView:function(t){var f=this.scrollable(),o=this.dataView,r=this.getVisibleView(),i,e=t=="next"?1:-1,u;i=t!="today"?this.getViewHandler().getNextDate(r,e):new Date;u=this.getBlockByDate(r,i);u.length?this.scroll({date:i,animate:!0,view:r}):(this.navigateDate=i,n.presenter("show",{id:this.dataView._id,name:"calendar",container:f}))},loadData:function(n){var t=this,f=t.dataView.extension().viewStyle();if(this.mode=="agenda"&&t.activeCalendar.colorMap.load(!0),n.is(":visible")&&this.mode!="agenda"&&f=="calendar"){var i=n.closest(".app-wrapper"),r=t.getFirstVisibleBlock(i),u=t.getLastVisibleBlock(i);r.length&&u.length&&t.loadDataInBlock(n,r,u)}},loadDataInBlock:function(n,t,r){function h(){o?u.loadDataInBlock(n,o,r):u.activeCalendar.colorMap.load(!0)}var u=this,o=t.next(":not(.current-time-line)"),s=u.mode,f,e;if(t[0]!=r[0]&&o.length||(o=null),!this.loadingData&&u.mode!="agenda")if(t.hasClass("data-loaded"))h();else{if(!u.blockIsVisible(n,t)){h();return}f=i(t);e=this.cache.select(f);e?($.isEmptyObject(e)||this.getViewHandler().addData(n,f,e),this.loadingData=!1,t.addClass("data-loaded"),h()):this.requestData({mode:s,date:f,success:function(i){u.cache.insert(f,i.Pivots.pivot0.Data.slice(1));callback=function(){if(u.blockIsVisible(n,t)){switch(s){case"day":t.find("td > ul").empty();break;case"week":t.find("td > ul").empty();break;case"month":t.find("td > ul").empty();break;case"year":t.find("td.app-has-data").removeClass("app-has-data");break;case"agenda":return}t.addClass("data-loaded");e=u.cache.select(f);$.isEmptyObject(e)||u.views[s].addData(n,f,e);h()}pt=null};yt&&!s.match(/day|week/)?pt=callback:callback()}})}},requestData:function(n){var i=this,t=i.activeCalendar,u={controller:i.dataView._controller,command:n.mode=="agenda"?"Select":"Pivot",view:i.dataView._viewId,sort:t.date.Name,tags:i.dataView.get_tags(),fieldFilter:[t.date.Name],success:function(t){i.loadingData=!1;n.success(t)},error:function(n){i.loadingData=!1;$app.alert(String.format("{0}",n.get_message()))}};if(t.text&&(u.fieldFilter.push(t.text.Name),t.text.AliasIndex!=0&&u.fieldFilter.push(i.dataView._allFields[t.text.AliasIndex].Name)),t.color&&(u.fieldFilter.push(t.color.Name),t.color.AliasIndex!=0&&u.fieldFilter.push(i.dataView._allFields[t.color.AliasIndex].Name)),t.end&&u.fieldFilter.push(t.end.Name),n.mode){t=i.activeCalendar;var o=n.date,r=new Date(o),e={},f=e[t.date.Name]=["calendar-date","pivot-val2-count","pivot-row1-year","pivot-row2-month-raw","pivot-row3-day"],s=e[t.text.Name],h=t.color?e[t.color.Name]:null,c=t.end?e[t.end.Name]=["calendar-end"]:null;s||(s=e[t.text.Name]=["calendar-text"]);t.color&&!h&&(h=e[t.color.Name]=["calendar-color"]);switch(n.mode){case"daylist":r.setDate(r.getDate()+1);f.push("pivot-val1-calendar-first100");break;case"day":r.setDate(r.getDate()+1);f.push("pivot-row4-halfhour");f.push("pivot-val1-calendar");break;case"week":r.setDate(r.getDate()+7);f.push("pivot-row3-day","pivot-row4-halfhour");f.push("pivot-val1-calendar");break;case"month":r.setMonth(r.getMonth()+1);f.push("pivot-row3-day");f.push("pivot-val1-calendar-first5");break;case"year":r.setYear(r.getFullYear()+1);f.push("pivot-row3-day")}r.setSeconds(-1);u.pivotDefinitions=e;u._filter=ct(i.dataView,t.date,null,o,r)}else n.pivots&&n.date&&n.end&&(u.pivotDefinitions=n.pivots,u._filter=ct(i.dataView,t.date,null,n.date,n.end));i.loadingData=!0;$app.execute(u)},blockIsVisible:function(n,t){var i;if(!n.is(":visible"))return!1;if(i=n.closest(".app-wrapper"),this.mode.match(/month|year/)){var r=i.offset().top,f=r+i.height(),u=t.offset().top,e=u+t.height(),s=u<=f&&u>=r,h=e>=r&&e<=f,c=u<=r&&e>=f;return s||h||c}if(this.mode.match(/day|week/)){var l=i.width(),o=t.position().left,a=o+t.width();return a>=0&&o<=l}return!0},hasKeyFields:function(){return this.dataView._keyFields.length>0},getCurrentKey:function(){if(!this.hasKeyFields())return null;var t=this.dataView._keyFields[0],n=this.dataView.extension().commandRow();return n?n[t.Index]:null},getEventTitle:function(n,t,i,r){var u=e(n,!0);return t&&(u+="-"+e(t,!0)),u+="\n"+(i?i:s.Data.NullValueInForms),this.activeCalendar.color&&r!=""&&(u+="\n"+(r?r:s.Data.NullValueInForms)),u},getActionsByName:function(t){var i=[],r=[];return n.navContext(i),i.forEach(function(n){n.command==t&&r.push(n)}),r},drawDayData:function(n,t,i,r){var u=this;i.rows.forEach(function(t){var i=u.drawEvent(t,r);i.appendTo(n)});this.resizeDayData(n.find("li"))},drawEvent:function(t,i){var f=this,y=t[0],o=t[1],u=t[2],c=t[3],h=t[4],l=e(o,!1,!0),a=e(o);u&&(l+="-"+e(u,!1,!0),a+=" - "+e(u));var v=String.format('<div class="app-event-data"><span class="app-event-time">{0}<\/span> {1} <div class="app-event-time-long">{2}<\/div><\/div>',l,h?h:s.Data.NullValueInForms,a),r=$('<li class="app-event"><\/li>').data("data-context",t),p=f.getEventTitle(o,u,h,c),w=f.activeCalendar.colorMap.className(c);return n.desktop()&&!this.dataView.get_isTagged("calendar-drag-disabled")&&(r.attr("data-draggable","calendar-event"),f.activeCalendar.end&&(v+='<div class="app-event-handle ui-icon-dots" data-draggable="calendar-event-handle"><\/div>')),i&&i==y&&r.addClass("app-calendar-selected"),u&&r.addClass("app-event-has-end-time"),r.addClass(w),r.html(v),r.attr("title",p),r},resizeDayData:function(n){var e=[],t=[],h=a/25,o=n.first().closest(".app-calendar-day").width()-(this.mode=="day"?150:10),c=this.mode=="day"?10:4,i,u,f,r;n.each(function(){var i=$(this);if(i.is(".app-event-more")){i.remove();return}var r=i.data("data-context"),t=r[1],n=r[2];!n||n.getTime()<t.getTime()?(n=new Date(t),n.setMinutes(n.getMinutes()+nu)):n.getDate()!=t.getDate()&&(n=new Date(t.getFullYear(),t.getMonth(),t.getDate(),23,59,59));e.push({element:i,data:r,start:t.getTime(),end:n.getTime(),depth:1,width:0})});e.sort(function(n,t){return n.start!=t.start?n.start>t.start?1:-1:n.end!=t.end?n.end<t.end?1:-1:0});u=[];r=0;e.forEach(function(n){function e(){n.depth=t.length+1;n.depth>r&&(r=n.depth);t.push(n);u.push(n)}for(i=t.pop();i;)if(i.end<=n.start)i=t.pop(),i||(u.forEach(function(n){n.width=r}),r=0,u=[]);else{t.push(i);break}t.length>=c?f?(n.collapsed=!0,f.collapsedEvents.push(n.data)):(f=n,f.collapsedEvents=[n.data],e()):(f=null,e())});u.forEach(function(n){n.width=r});e.forEach(function(n){var i,r;if(n.collapsed)n.element.hide();else{var t=n.element,u=n.data[1],e=n.data[2],c=h*(u.getHours()+u.getMinutes()/60)+22,l=pr(n.start,n.end),f=o/n.width,a=o*(n.depth-1)/n.width;n.depth!=n.width&&(f*=1.3);n.collapsedEvents&&n.collapsedEvents.length>1&&(t.hide(),i="+"+n.collapsedEvents.length+" "+s.Mobile.More,t=$('<li class="app-event app-event-more ui-icon-dots"><\/li>').appendTo(t.closest("ul")).html(i).attr("title",i).data("data-more-context",n.collapsedEvents));r={top:c,"z-index":n.depth+2,marginLeft:a+"px",width:f-3+"px"};e&&(r.height=l);t.css(r)}})}};bi=function(n){this.calendar=n};bi.prototype={draw:function(n,t){var u,l;n.find(".app-calendar-dayview").remove();var i=$('<div class="app-calendar-dayview"><\/div>').appendTo(n),h=i.closest(".app-echo").length>0,c=i.closest(".app-presenter"),a=i.closest(".app-wrapper"),e=c.data("cal-header"),s=h?1:y.day*7,v=(y.day-1)/2*7,r=new Date(t.getFullYear(),t.getMonth(),t.getDate()),f='<div class="app-calendar-day-grid"><div class="current-time-line"><div class="dot"><\/div><\/div>';return r.setDate(r.getDate()-o[r.getDay()]),e.find(".app-day-header").remove(),u=$('<div class="app-day-header" data-draggable="calendar-bar-day"><\/div>').appendTo(e),l=$("<ul> "+this.calendar.drawDayHeaders(r,s)+" <\/ul>").appendTo(u),d(u),f+=this.calendar.drawDayColumns(r,s,!0),f+="<\/div>",i.html(f).find(".app-calendar-day").hide(),this.resize(i,u,null),this.scroll({view:i,date:t,enhancePrecision:!0}),i},showHeaderAndFooter:function(n){n.find(".app-day-header").show();n.find(".app-week-header").hide();n.find(".app-month-header").hide();this.calendar.lastDayScrollTop=this.calendar.scrollable().scrollTop()},resize:function(n,t){t.is(".app-day-header")||(t=t.find(".app-day-header"));var r=n.closest(".app-echo").length>0,w=n.find(".app-calendar-day-grid"),u=n.find(".app-calendar-day"),i=t.find("li"),b=this.calendar.scrollable(),f=b.outerWidth(),k=Math.floor(f/7),d=u.length*f,s=this.calendar.navigateDate&&!this.calendar.preventNavigate,e,o,c,l,v,y;if(s||(e=it(u),o=r?null:it(i),c=e.position().left,l=r?0:o.position().left,v=parseInt(n.css("marginLeft"),10)*-1,y=r?0:parseInt(t.css("marginLeft"),10)*-1),w.width(d),t.width(i.width()*i.length),i.closest("ul").css("visibility",""),i.width(k),u.width(f).fadeIn("fast"),n.height(a),!r)if(s)this.scroll({view:n,date:this.calendar.navigateDate});else{var g=e.position().left,nt=o.position().left,tt=c-g,p=Math.floor(l-nt);p!=0&&t.css("marginLeft",y*-1+p);this._scroll(n,t,v-tt,null)}h();this.resizeData(n)},scroll:function(t){var e=this,r=e.calendar,o=r.dataView.extension().commandRow(),v=r.scrollable(),u=t.view,y=t.animate,p=u.closest(".app-presenter"),w=p.data("cal-header").find(".app-day-header"),i=t.date,s=r.getBlockByDate(u,i),c,l,f,a;s.length&&(c=parseInt(u.css("marginLeft"),10),l=s.position().left,e._scroll(u,w,l-c,null,y));t.enhancePrecision&&(o?(a=o[r.activeCalendar.date.Index],f=h(a,"find")):f=i.getHours()==0&&i.getMinutes()==0&&i.getSeconds()==0&&i.getMilliseconds()==0?r.lastDayScrollTop||h():h(i,"find"),n.scroll(v,f))},_scroll:function(t,r,u,f,e){var h;n.animate()||(e=!1);var l=parseInt(t.css("marginLeft"),10),s=u*-1,o=this,c=t.find(".app-calendar-day-grid");if(t.removeClass("app-has-current-day"),si++,e==!0){t.animate({marginLeft:s},bt,function(){o._scroll(t,r,u,null)});return}t.css("marginLeft",s);h=this.updateDayHeader(t,r);clearTimeout(wt);wt=setTimeout(function(){var n=t.find(".app-calendar-day"),f=it(n),v=n.width(),e=u%v,a,w=y.day*7,b=hi.day*7,g,nt,ot,p,tt,st,ht,k,d;if(si==1&&e!=0?(s>l?(e=e*-1,f=f.prev(),f.is(".current-time-line")&&(f=f.prev())):(e=v-e,f=f.next(),f.is(".current-time-line")&&(f=f.next())),h=o.updateDayHeader(t,r,f)):e=e>v/2?v-e:e*-1,nt=s-e,ot=nt*-1,u<v)p=n.first(),g=p.position().left,a=i(p),a.setDate(a.getDate()-w),$(o.calendar.drawDayColumns(a,w,!0)).width(v).prependTo(c),st=$(o.calendar.drawDayHeaders(a,w)).width(v/7).prependTo(r.find("ul")),n=t.find(".app-calendar-day"),ht=r.find("li"),n.length>b&&(n.slice(b,n.length).remove(),r.find("li").slice(b,n.length).remove()),t.css("marginLeft",(p.position().left-g)*-1),r.css("marginLeft",h.position().left*-1);else if(u>n.width()*(n.length-2)){p=n.last();g=p.position().left;a=i(p);a.setDate(a.getDate()+1);$(o.calendar.drawDayColumns(a,w,!0)).appendTo(c);$(o.calendar.drawDayHeaders(a,w)).appendTo(r.find("ul"));var ht=r.find("li"),rt=n.length+w,ut=0;tt=0;rt>b&&(k=n.slice(0,rt-b),d=r.find("li").slice(0,rt-b),ut=k.width()*k.length,tt=d.width()*d.length,k.remove(),d.remove());t.css("marginLeft",parseInt(t.css("marginLeft"),10)+ut-e);r.css("marginLeft",parseInt(r.css("marginLeft"),10)+tt)}else{function et(){o.calendar.updateHeader(r.closest(".app-bar-calendar"))}e!=0?t.animate({marginLeft:nt},{duration:bt,done:et}):et()}f.is(".current-day-column")&&t.addClass("app-has-current-day");ft();si=0},250)},updateDayHeader:function(n,t,r){var a=n.find(".app-calendar-day"),v=r&&r.length?r:it(a),u=i(v),s=it(t.find("ul li")),f=i(s),e=s,h,c,l;return t.find("li .visible-day").removeClass("visible-day"),h=t.find(String.format('li[data-cal-year="{0}"][data-cal-month="{1}"][data-cal-day="{2}"] > a > div',u.getFullYear(),u.getMonth(),u.getDate())),h.addClass("visible-day"),u.setDate(u.getDate()-o[u.getDay()]),f.setDate(f.getDate()-o[f.getDay()]),f.getTime()!=u.getTime()&&(e=t.find(String.format('li[data-cal-year="{0}"][data-cal-month="{1}"][data-cal-day="{2}"]',u.getFullYear(),u.getMonth(),u.getDate())),e.length&&(c=parseInt(t.css("marginLeft"),10),l=c-e.position().left,t.css("marginLeft",l))),this.calendar.updateHeader(t.closest(".app-bar-calendar")),e},addData:function(n,t,i){var f=this.calendar.getBlockByDate(n,t,"day"),r=f.find("ul.app-calendar-eventlist"),e=this.calendar.dataView._keyFields[0],u=this.calendar.dataView.extension().commandRow(),o=u?u[e.Index]:null;r.empty();typeof i!="boolean"&&this.calendar.drawDayData(r,t,i,o)},resizeData:function(n){var t=this.calendar,i=n.find(".app-calendar-day");i.each(function(){var i=$(this),n=i.find("li.app-event:not(.app-event-preview)");n.length&&t.resizeDayData(n)})},clear:function(n){var r=this.calendar.scrollable(),i=r.find(".app-calendar-dayview"),t;i.length&&(t=i.find("div.app-calendar-day.data-loaded"),t.removeClass("data-loaded").removeData("calendar-colors"),n&&t.find(".app-event").remove())},getNextDate:function(n,t){var u=this.calendar.getMostVisibleBlock(),r=i(u);return r.setDate(r.getDate()+t),r},getBlocks:function(){return this.calendar.scrollable().find(".app-calendar-dayview > .app-calendar-day-grid > .app-calendar-day")}};ki=function(n){this.calendar=n};ki.prototype={draw:function(n,t){var f,p,u,l;t.setDate(t.getDate()-o[t.getDay()]);n.find(".app-calendar-weekview").remove();var i=$('<div class="app-calendar-weekview"><\/div>').appendTo(n),e=this.calendar,a=i.closest(".app-echo").length>0,s=a?7:y.week,v=i.closest(".app-presenter"),w=i.closest(".app-wrapper"),c=v.data("cal-header"),r=new Date(t.getTime());return r.setDate(r.getDate()-s),c.find(".app-week-header").remove(),f=$('<div class="app-week-header" data-draggable="calendar-bar-week"><\/div>').appendTo(c),p=$("<ul>"+e.drawDayHeaders(r,s*3)+"<\/ul>").appendTo(f),d(f),u='<div class="app-calendar-week-grid"><div class="current-time-line"><div class="dot"><\/div><\/div>',u+=e.drawTimeColumn(r),u+=e.drawDayColumns(r,s*3,!1),u+="<\/div>",i.html(u),l=i.find(".app-calendar-week-grid").hide(),this.resize(i,f,null),this.scroll({view:i,date:t,enhancePrecision:!0}),this.validateCurrentDay(i,l),h(),i},showHeaderAndFooter:function(n){n.find(".app-day-header").hide();n.find(".app-week-header").show();n.find(".app-month-header").hide();this.calendar.lastDayScrollTop=this.calendar.scrollable().scrollTop()},_timelineDot:function(n,t){var o=this.calendar.scrollable(),u=n.find(".app-calendar-week-grid"),f,i=u.find(".current-time-line .dot"),e,r;t?(r=i.show().width(),f=u.find(".current-day-column"),f.length&&(e=f.offset().left-o.offset().left-r/2+parseInt(u.css("margin-left")),e+r<o.width()-r*3?setTimeout(function(){i.css("marginLeft",e).show()}):i.hide())):i.hide()},resize:function(n,t){t.is(".app-week-header")||(t=t.find(".app-week-header"));var r=n.closest(".app-echo").length>0,s=n.find(".app-calendar-week-grid"),c=n.find(".app-calendar-week-grid > div:not(.current-time-line):not(.app-calendar-time) > div"),i=t.find("li"),l=this.calendar.scrollable(),v=l[0].scrollWidth-st,u=Math.floor(v/7),y=u*(i.length+1)+st,f=it(i),p=r?0:f.position().left,e=r?0:parseInt(t.css("marginLeft"),10)*-1;if(i.width(u),i.closest("ul").css("visibility",""),c.width(u),s.width(y).fadeIn("fast"),n.height(a),!r){var w=f.position().left,o=p-w,b=e-o;this._timelineDot(n,!0);this._scroll(n,t,e-o,null);this.resizeData(n)}h()},scroll:function(t){var l,a,f,v;t.date.setDate(t.date.getDate()-o[t.date.getDay()]);var e=this,r=e.calendar,u=t.view,y=t.animate,i=t.date,s=r.dataView.extension().commandRow(),p=u.closest(".app-presenter"),w=r.scrollable(),b=p.data("cal-header").find(".app-week-header"),c=r.getBlockByDate(u,i);c.length&&(l=parseInt(u.css("marginLeft"),10),a=c.position().left-st,e._scroll(u,b,a-l,null,y));t.enhancePrecision&&(s?(v=s[r.activeCalendar.date.Index],f=h(v,"find")):f=i.getHours()==0&&i.getMinutes()==0&&i.getSeconds()==0&&i.getMilliseconds()==0?r.lastDayScrollTop||h():h(i,"find"),n.scroll(w,f))},_scroll:function(t,r,u,f,e){function ut(){c.updateHeader(it);b||(u<ht?ct():w.position().left<ot?lt():o.validateCurrentDay(t,h));ft(tt);o._timelineDot(t,!0)}function v(n,t,i){var r=i.getDate();n.attr("data-cal-year",i.getFullYear()).attr("data-cal-month",i.getMonth()).attr("data-cal-day",r).data("calendar-colors",t.data("calendar-colors")).find("ul").empty().append(t.find("ul li"));n[0].className=t[0].className}function et(n,t){var i=t.getDate();n.attr("data-cal-year",t.getFullYear()).attr("data-cal-month",t.getMonth()).attr("data-cal-day",i);n.data("calendar-colors",null);n.find("ul").empty().removeClass("data-loaded");n[0].className="app-calendar-day";g(t)&&n.addClass("current-day-column")}function ct(){b=!0;var p=s.first(),nt=h.find(".current-time-line"),f=i(p),y=!1;f.setDate(f.getDate()-k);var w=r.find("li"),e=s.slice(0,7),l=s.slice(7,14),d=s.slice(14,21),n=new Date(f);return w.each(function(){var r=$(this),t=r.find("a div"),i=n.getDate();t.text(i);r.attr("data-cal-year",n.getFullYear()).attr("data-cal-month",n.getMonth()).attr("data-cal-day",i);g(n)?t.addClass("app-current-day"):t.removeClass("app-current-day");n.setDate(i+1)}),n=i(l.first()),d.each(function(t){v($(this),l.eq(t),n);n.setDate(n.getDate()+1)}),n=i(e.first()),l.each(function(t){v($(this),e.eq(t),n);n.setDate(n.getDate()+1)}),n=f,e.each(function(){et($(this),n);var i=c.cache.select(n);i&&(o.addData(t,n,i),y=!0);n.setDate(n.getDate()+1)}),o.validateCurrentDay(t,h),y&&o.resizeData(t),u-=a,u>0&&(u=0),t.css("marginLeft",u),r.css("marginLeft",u),a}function lt(){b=!0;var p=s.first(),nt=h.find(".current-time-line"),e=i(p),y=!1;e.setDate(e.getDate()+k);var w=r.find("li"),d=s.slice(0,7),l=s.slice(7,14),f=s.slice(14,21),n=new Date(e);return w.each(function(){var r=$(this),t=r.find("a div"),i=n.getDate();t.text(i);r.attr("data-cal-year",n.getFullYear()).attr("data-cal-month",n.getMonth()).attr("data-cal-day",i);g(n)?t.addClass("app-current-day"):t.removeClass("app-current-day");n.setDate(i+1)}),n=i(l.first()),d.each(function(t){v($(this),l.eq(t),n);n.setDate(n.getDate()+1)}),n=i(f.first()),l.each(function(t){v($(this),f.eq(t),n);n.setDate(n.getDate()+1)}),n=i(f.last()),n.setDate(n.getDate()+1),f.each(function(){et($(this),n);var i=c.cache.select(n);i&&(o.addData(t,n,i),y=!0);n.setDate(n.getDate()+1)}),o.validateCurrentDay(t,h),u-=a,y&&o.resizeData(t),u>0&&(u*=-1),t.css("marginLeft",u),r.css("marginLeft",u),a}var p,d,nt;n.animate()||(e=!1);var o=this,c=o.calendar,tt=c.scrollable(),ot=tt.width(),h=t.find(".app-calendar-week-grid"),s=h.find(".app-calendar-day"),it=r.closest(".app-bar-calendar"),w=s.last(),l=w.width(),at=w.position().left-st+l,b=!1,rt=r.find("li:first-of-type"),vt=i(rt),ht=rt.width()+2,yt=hi.week,k=y.week,a=l*k;o._timelineDot(t,!1);c.updateHeader(it);e==!0?(p=u%l,d=u*-1+(p>l/2?p-l:p),r.animate({marginLeft:d},bt),t.animate({marginLeft:d},bt,function(){setTimeout(function(){ut()})})):(nt=u*-1,r.css("marginLeft",nt),t.css("marginLeft",nt),clearTimeout(wt),wt=setTimeout(ut,250))},addData:function(n,t,i){var f=this.calendar.dataView._keyFields[0],u=this.calendar.dataView.extension().commandRow(),e=u?u[f.Index]:null,o=this.calendar.getBlockByDate(n,t,"day"),r=o.find("ul.app-calendar-eventlist");r.empty();r.data("calendar-event-count",i.count||0);this.calendar.drawDayData(r,t,i,e)},resizeData:function(n){var t=this.calendar,i=n.find(".app-calendar-day");i.each(function(){var i=$(this),n=i.find("li.app-event:not(.app-event-preview)");n.length&&t.resizeDayData(n)})},clear:function(n){var r=this.calendar.scrollable(),i=r.find(".app-calendar-weekview"),t;i.length&&(t=i.find("div.app-calendar-day.data-loaded"),t.removeClass("data-loaded").removeData("calendar-colors"),n&&t.find(".app-event").remove())},validateCurrentDay:function(n,t){n.is(".app-has-current-day")?t.find(".current-day-column").length||n.removeClass("app-has-current-day"):t.find(".current-day-column").length&&n.addClass("app-has-current-day")},getNextDate:function(n,t){var f=this.calendar.getMostVisibleBlock(),r=i(f),u=o[r.getDay()];return u==0?r.setDate(r.getDate()+t*7):r.setDate(r.getDate()+(t==-1?u*-1:7-u)),r},getBlocks:function(){var n=this.calendar.scrollable();return n.find(".app-calendar-weekview > .app-calendar-week-grid > .app-calendar-day")}};di=function(n){this.calendar=n};di.prototype={draw:function(n,i){var e,w,v,rt,it,p,ut;n.find(".app-calendar-monthview").remove();var r=$('<div class="app-calendar-monthview"><\/div>').hide().appendTo(n),ft=this.calendar,s=r.closest(".app-echo").length>0,nt=r.closest(".app-presenter"),h=nt.data("cal-header"),c=s?0:y.month,tt=i.getMonth(),f=new Date(i.getFullYear(),tt,1),a,it,u;for(f.setMonth(f.getMonth()-c),a=f.getMonth(),h.find(".app-month-header").remove(),e=$('<div class="app-month-header"><\/div>'),w=$("<ul><\/ul>").appendTo(e),u=0;u<7;u++){var o=ht[u],b=t.DayNames[o],k=t.AbbreviatedDayNames[o],g=$('<li><span class="letter-day">'+k.substring(0,1)+'<\/span><span class="abbr-day">'+k+'<\/span><span class="full-day">'+b+"<\/span><\/li").attr("title",b);(o==0||o==6)&&g.addClass("app-calendar-weekend");g.appendTo(w)}for(d(e),e.appendTo(h),$app.touch.bar("show",h),r.fadeIn("fast"),v=$('<div class="app-calendar-load-at-top"><\/div>').appendTo(r),rt=$('<a href="#" class="dv-load-at-top ui-btn"/>').appendTo(v).text(l.Loading),s&&v.hide(),u=c*-1;u<=c;u++)it=this.drawMonth(f).appendTo(r),f.setMonth(a+1),a=f.getMonth();return this.resize(r),p=$('<div class="app-calendar-load-at-bottom"><\/div>').appendTo(r),ut=$('<a href="#" class="dv-load-at-bottom ui-btn">Load more<\/a>').appendTo(p).text(l.Loading),s&&p.hide(),this.scroll({date:i,view:r}),r},showHeaderAndFooter:function(n){n.find(".app-day-header").hide();n.find(".app-week-header").hide();n.find(".app-month-header").show()},resize:function(n,t,i,r){var o=n.closest(".app-wrapper"),u=n.find(".app-calendar-month"),f=u.find("table"),e=o.height()-u.first().find(".app-calendar-month-header").outerHeight();r&&u.removeClass("data-loaded");f.height(e);f.each(function(){var t=$(this),n=t.find("tr");n.height(e/n.length)});this.calendar.navigateDate&&!this.calendar.preventNavigate&&this.scroll({view:n,date:this.calendar.navigateDate})},scroll:function(t){var s=this,l=t.date,r=s.calendar,u=r.getBlockByDate(t.view,t.date);if(u){var i=r.scrollable(),h=t.view.closest("div.app-presenter"),a=h.data("cal-header"),f=u.find(".app-calendar-month-header"),c=i.find(".app-presenter-instruction"),e=f.offset().top-i.offset().top+f.outerHeight(!0)-c.outerHeight(!0)+i.scrollTop(),o=function(){n.fetchOnDemand();ft(i)};t.animate?n.animatedScroll(i,e,o):(n.scroll(i,e),o())}},clear:function(n){var r=this.calendar.scrollable(),i=r.find(".app-calendar-monthview"),t;i.length&&(t=i.find("div.app-calendar-month.data-loaded"),t.removeClass("data-loaded").removeData("calendar-colors"),n&&t.find(".app-event").remove())},drawMonth:function(n){var s=n.getMonth(),c=t.MonthNames[s],h=$('<div class="app-calendar-month"><\/div>').attr("data-cal-year",n.getFullYear()).attr("data-cal-month",s),l=$('<h1 class="app-calendar-month-header">').appendTo(h),y=$("<table><\/table>").appendTo(h),e,r;s==0?l.text(String.format("{0} {1}",c,n.getFullYearText())):l.text(c);var i=new Date(n.getFullYear(),n.getMonth(),1),u=o[i.getDay()],f=new Date(n.getFullYear(),n.getMonth()+1,1),a=o[f.getDay()],v;for(a!=0&&f.setDate(f.getDate()+(6-a)+1),u!=0&&i.setDate(i.getDate()-u);i<f;){if(e=i.getDay(),u=o[e],u==0&&(v=$("<tr><\/tr>").appendTo(y)),r=$("<td><\/td>").appendTo(v),(e==0||e==6)&&r.addClass("app-calendar-weekend"),i.getMonth()==n.getMonth()){r.html("&nbsp;");r.attr("data-cal-day",i.getDate());var p=$('<a class="ui-btn"><\/a>').appendTo(r),w=$("<span><\/span>").text(i.getDate()).appendTo(p),b=$("<ul><\/ul>").appendTo(r),k=$('<li class="app-calendar-month-more"><\/li>').appendTo(b);ot.setHours(0,0,0,0)==i.setHours(0,0,0,0)&&w.addClass("app-current-day")}else r.html("&nbsp;");i.setDate(i.getDate()+1)}return h},addData:function(n,t,i){var o=this.calendar,l=o.getBlockByDate(n,t,"month"),tt=o.dataView,ot=tt._keyFields[0],st=o.activeCalendar,r=o.dataView.extension().commandRow(),w=r?r[ot.Index]:null,a=r?r[st.date.Index]:null,it,v,ht=l.find("td").first(),ct=l.find("td > a").first(),rt=l.find("ul"),b,et;rt.hide();it=ht.outerHeight()-ct.height();rt.show();for(b in i){var k=i[b],d=k.count,h=null,y=l.find('td[data-cal-day="'+b+'"] ul'),f=0,p,c=$('<li class="app-calendar-month-more"><\/li>');for(v=!1,y.empty().data("calendar-event-count",d);f<5;){if(r=k.rows[f],!r)break;t=r[1];var lt=r[0],g=r[2],ut=r[3],nt=r[4],ft=e(t,!1,!0);g&&(ft+="-"+e(g,!1,!0));var at=String.format('<span class="app-event-time">{0}<\/span> {1}',ft,nt?nt:s.Data.NullValueInForms),u=$('<li class="app-event"><\/li>').data("data-context",r),vt=o.getEventTitle(t,g,nt,ut),yt=o.activeCalendar.colorMap.className(ut);if(tt.get_isTagged("calendar-drag-disabled")||u.attr("data-draggable","calendar-event"),h||(h=t),w&&w==lt&&(u.addClass("app-calendar-selected"),p=u),u.addClass(yt),u.html(at),u.attr("title",vt),u.appendTo(y),f++,y.height()>it&&d!=1){u.remove();v=!0;f--;break}}(v||f<k.count)&&(c.appendTo(y),v&&(et=c.prev(),et.length&&(c.prev().remove(),f--)),c.html(String.format(iu,d-f)),w&&a&&a.getDate()==h.getDate()&&a.getMonth()==h.getMonth()&&a.getFullYear()==h.getFullYear()&&(p&&(!p||p.is(":visible"))||c.addClass("app-calendar-selected")))}},getNextDate:function(n,t){var u=this.calendar,e=u.getMostVisibleBlock(),r=i(e),n,f;return r.setMonth(r.getMonth()+t,1),n=u.getVisibleView(),f=u.getBlockByDate(n,r),f.length||(t==1?n.find(".dv-load-at-bottom").trigger("vclick"):n.find(".dv-load-at-top").trigger("vclick")),r},getBlocks:function(){var n=this.calendar.scrollable();return n.find(".app-calendar-monthview > .app-calendar-month")}};gi=function(n){this.calendar=n};gi.prototype={draw:function(n,t){var r,h,f,c;n.find(".app-calendar-yearview").remove();var i=$('<div class="app-calendar-yearview"><\/div>').hide().appendTo(n),u=i.closest(".app-echo").length>0,e=u?0:y.year,o=t.getFullYear(),s=$('<div class="app-calendar-load-at-top"><\/div>').appendTo(i),a=$('<a href="#" class="dv-load-at-top ui-btn"/>').appendTo(s).text(l.Loading);for(u&&s.hide(),r=o-e;r<=o+e;r++)h=this.drawYear(new Date(r,0)).appendTo(i);return i.fadeIn("fast"),f=$('<div class="app-calendar-load-at-bottom"><\/div>').appendTo(i),c=$('<a href="#" class="dv-load-at-bottom ui-btn">Load more<\/a>').appendTo(f).text(l.Loading),u&&f.hide(),this.scroll({view:i,date:t}),i},showHeaderAndFooter:function(n){n.find(".app-day-header").hide();n.find(".app-week-header").hide();n.find(".app-month-header").hide()},drawYear:function(n){for(var h,r,u,e,o,s=n.getFullYear(),f='<div class="app-calendar-year" data-cal-year="'+s+'"><h1>'+n.getFullYearText()+"<\/h1>",i=0;i<=11;i++){for(h=t.AbbreviatedMonthNames[i].toUpperCase(),r='<div class="app-calendar-month" data-cal-month="'+i+'"><a class="ui-btn app-calendar-month-header">'+h+"<\/a><table><thead>",u=0;u<7;u++)r+="<th>"+t.ShortestDayNames[ht[u]].substr(0,1)+"<\/th>";r+="<\/thead><tbody>";r+=vr(s,i);f+=r+"<\/tbody><\/table><\/div>"}return f+='<div class="app-clear-fix"><\/div><\/div>',e=$(f),o=this.calendar.cache.select(n),o&&this.addData(null,n,o,e.addClass("data-loaded")),e},addData:function(n,t,i,r){var f=this.calendar,e=r||f.getBlockByDate(n,t,"year"),u,o,s;e.find("td.app-has-data").removeClass("app-has-data").attr("title",null);for(u in i)o=i[u],s=e.find('div[data-cal-month="'+u+'"]'),s.find("td").each(function(){var t=$(this),i=t.text(),n;i.trim().length&&(n=o[i],n&&n.count&&t.addClass("app-has-data").attr("title",String.format("{0} ({1})",f.activeCalendar.date.Label,n.count)))})},scroll:function(t){function o(){n.fetchOnDemand();u.updateHeader(l);ft(i)}var s=this,h=t.date,u=s.calendar,i=u.scrollable(),c=t.view.closest("div.app-presenter"),l=c.data("cal-header"),r=u.getBlockByDate(t.view,t.date),e,f;r&&(r=r.find('div.app-calendar-month[data-cal-month="'+h.getMonth()+'"]'),e=i.find(".app-presenter-instruction"),f=r.offset().top+i.scrollTop()-i.offset().top-e.outerHeight(),t.animate?n.animatedScroll(i,f,o):(n.scroll(i,f),o()))},clear:function(n){var r=this.calendar.scrollable(),i=r.find(".app-calendar-yearview"),t;i.length&&(t=i.find("div.app-calendar-year.data-loaded"),t.removeClass("data-loaded").removeData("calendar-colors"),n&&t.find(".app-has-data").removeClass("app-has-data").attr("title",null))},resize:function(n){this.calendar.navigateDate&&this.scroll({view:n,date:this.calendar.navigateDate})},getNextDate:function(n,t){var u=this.calendar,e=u.getMostVisibleBlock(),r=i(e),n,f;return r.setYear(r.getFullYear()+t),n=u.getVisibleView(),f=u.getBlockByDate(n,r),f.length||(t==1?n.find(".dv-load-at-bottom").trigger("vclick"):n.find(".dv-load-at-top").trigger("vclick")),r},getBlocks:function(){var n=this.calendar.scrollable();return n.find(".app-calendar-yearview > .app-calendar-year")}};nr=function(n){this.calendar=n};nr.prototype={draw:function(n,t){var i=n.find(".app-calendar-agendaview");i.length||(i=$('<div class="app-calendar-agendaview"><\/div>').appendTo(n));var r=this,f=this.calendar,y=f.activeCalendar,p=f.dataView,h=i.closest(".app-echo").length>0,e=new Date(t),u=i.find(".app-calendar-agenda-list"),a=u.length&&i.is(".data-loaded"),v=i.closest(".app-wrapper"),c=v.find(".app-presenter-instruction"),o=i.find(".app-calendar-load-at-top"),s=i.find(".app-calendar-load-at-bottom");return h?i.height(f.echoMaxHeight):c.css("visibility","hidden"),a||(u.length||(u=$('<ul class="app-calendar-agenda-list"><\/ul>').hide().appendTo(i)),h||(o.length||(o=$('<div class="app-calendar-load-at-top"><\/div>').hide().prependTo(i),$('<a href="#" class="dv-load-at-top ui-btn"/>').text(l.Loading).appendTo(o)),s.length||(s=$('<div class="app-calendar-load-at-bottom"><\/div>').hide().appendTo(i),$('<a href="#" class="dv-load-at-bottom ui-btn"><\/a>').text(l.Loading).appendTo(s)))),f.cache.clearAgenda(),r.minPage=0,r.maxPage=0,r.todayLoaded=!1,r.lastDate=e,r.loadData(i,e,0,function(n,f){r.loadData(i,e,-1,function(l,a){var v;u.empty();var tt={"0":n["0"],"-1":l["-1"]},p=r.drawData(i,e,tt),w=r.calendar.cache.select(1),b=r.calendar.cache.select(-2);if(u.show(),i.fadeIn("fast").css("height",""),h){var k=p[0],it=p[1],d=f+a,g=k+it,y=a-k+1,nt=y+g-1;g!=d&&(v=footer.find(".dv-action-see-all"),v.empty(),footer.show(),$('<span class="app-btn-see-all"/>').appendTo(v).text(et.SeeAll).attr("title",et.SeeAll),$('<span class="app-info"/>').appendTo(v).attr({"data-start-index":y,"data-end-index":nt}).html(String.format(ii.ShowingItems,y,nt,d)))}else c.css("visibility",""),w&&w.length==0||s.show(),b&&b.length==0||o.show(),r.scroll({view:i,date:t})})}),i},showHeaderAndFooter:function(n){n.find(".app-day-header").hide();n.find(".app-week-header").hide();n.find(".app-month-header").hide()},getNextDate:function(n,t){var u=this.calendar.scrollable(),s=u.scrollTop(),f=this.calendar.getFirstVisibleBlock(u),h=n.find(".app-calendar-agenda-list li:not(.app-calendar-month-header)").first(),e,o,r;return i(f).getTime()==i(h).getTime()?(e=n.find(".dv-load-at-top"),e.is(":visible")&&e.trigger("vclick")):t==1&&s+u.height()>u[0].scrollHeight-20&&(o=n.find(".dv-load-at-bottom"),o.is(":visible")&&o.trigger("vclick")),r=t==1?f.next():f.prev(),r.is(".app-calendar-month-header")&&(r=t==1?r.next():r.prev()),r.length?i(r):i(f)},scroll:function(t){var s=this.calendar,f=t.view||s.getVisibleView(),e=t.date,o,h;if(!f.hasClass("data-loaded")){this.draw(f.closest(".app-calendar"),e);return}var u=s.scrollable(),l=f.closest(".app-presenter"),y=l.data("cal-header"),r=s.getBlockByDate(f,e),c=this.getBlocks().first(),a=i(c),v=u.find(".app-presenter-instruction");if(r.length)r=r.closest(".app-agenda-day-list");else for(r=c;r.length&&i(r)<=e;)r=r.next(),r.is(".app-calendar-month-header")&&(r=r.next());r.length&&(o=0,h=function(){n.fetchOnDemand();ft(u)},ai(e,a)||(o=u.scrollTop()+r.offset().top-u.offset().top-v.height()),t.animate?n.animatedScroll(u,o,h):(n.scroll(u,o),h()))},resize:function(n){this.calendar.navigateDate&&this.scroll({view:n,date:this.calendar.navigateDate})},clear:function(n){n||(n=this.calendar.getViews().filter(".app-calendar-agendaview"));n.removeClass("data-loaded");n.find(".app-calendar-load-at-top, .app-calendar-load-at-bottom").hide();this.todayLoaded=!1;this.calendar.cache.clearAgenda()},loadData:function(n,t,i,r){var c;t||(t=this.lastDate);var f=this,u=f.calendar,o=u.activeCalendar,s=u.dataView,v=n.closest(".app-echo").length>0,y=n.find(".app-calendar-agenda-list"),h=i<0,a=o.date.Name+(h?" desc":" asc"),e={},l=i>=0?i:Math.abs(i)-1;i>f.maxPage?f.maxPage=i:i<f.minPage&&(f.minPage=i);c=u.cache.select(i);c?(e[i]=c,r?r(e):f.drawData(n,t,e)):(u.loadingData=!0,$app.execute({controller:s._controller,view:s._viewId,command:"Select",_filter:h?ct(s,o.date,o.end,null,t):ct(s,o.date,o.end,t,null),sort:a,pageSize:kt*2,pageIndex:l/2,requiresRowCount:!0,tags:s.get_tags(),includeRawResponse:!0,success:function(o){var a,v,s,c;(u.loadingData=!1,a=o.rawResponse.Rows,v=o.totalRowCount<=(l+1)*kt*2,u.mode=="agenda")&&(s=a.splice(0,kt),c=a,h?(s.reverse(),c.reverse(),u.cache.insert(i,s),u.cache.insert(i-1,c),v&&u.cache.insert(i-2,[])):(u.cache.insert(i,s),u.cache.insert(i+1,c),v&&u.cache.insert(i+2,[])),e[i]=s,r?r(e,o.totalRowCount):f.drawData(n,t,e,o.totalRowCount))},error:function(n){u.loadingData=!1;$app.alert(String.format("{0}",n.get_message()))}}))},drawData:function(i,r,u){function bt(n,t){var w=b&&n[b.Index],r=n[ui],u=n[yt],o=pt!==undefined&&n[pt],y=ht!==undefined&&n[ht],k=f.colorMap.className(y),p=a.getDayList(h,r,t?"prepend":"append"),i=$("<li><\/li>").attr("data-cal-page",ot),d=$('<span class="app-event-time"><\/span>').appendTo(i),l=e(r),v=$('<div class="app-event"><\/div>').text(u?u:s.Data.NullValueInForms).data("data-context",n).appendTo(i);return v.attr("title",c.getEventTitle(r,o,u,y)).addClass(k),it&&it==w&&v.addClass("app-calendar-selected"),o&&(l+=" - "+e(o)),d.text(l),$('<div class="app-event-time"><\/div>').text(l).appendTo(v),t?i.prependTo(p):i.appendTo(p),i}var a=this,c=a.calendar,h=i.find(".app-calendar-agenda-list"),ii=c.scrollable(),ri=i.closest(".app-echo").length>0,f=c.activeCalendar,vt=c.dataView,ui=f.date.Index,yt=f.text.Index,ht=f.color&&f.color.Index,pt=f.end&&f.end.Index,b=c.dataView._keyFields[0],wt=c.dataView.extension().commandRow(),it=wt?wt[b.Index]:null,rt=c.getMostVisibleBlock(),fi=rt?rt.position().top:0,v,ct,et,nt,lt,at,ot,tt,st,l,y,gt;if(f.text.AliasName&&f.text.AliasName.length&&(v=vt.findField(f.text.AliasName),v&&(yt=v.Index)),f.color&&f.color.AliasName&&f.color.AliasName.length&&(v=vt.findField(f.color.AliasName),v&&(ht=v.Index)),ri){for(var y=a.calendar.cache.select(0),l=a.calendar.cache.select(-1),ei=l.length&&l[0][b.Name],p=0,d=0,w=!0,ut=!0,dt=c.echoMaxHeight,oi=y.length+l.length,g=0,o,ft;(h.outerHeight(!0)<dt||g<3)&&g<oi;){if(y.length<=p&&(w=!1),l.length<=d){if(y.length<=p)break;w=!0;ut=!1}ct=w&&!ut?y[p++]:l[d++];ct?(g++,bt(ct,!w)):(w?p--:d--,w=!1);ut&&(ut=!1)}for(a.validateToday(h,h.children(),r),o=h.find(".app-agenda-day-list:first"),ft=o.attr("data-cal-year"),o.length&&ft!=(new Date).getFullYear().toString()&&$("<h1/>").appendTo($('<li class="app-calendar-month-header" data-cal-year="'+ft+'" data-cal-month="'+o.attr("data-cal-month")+'"/>').insertBefore(o)).text(ft),o=h.find("li.app-agenda-day-list").first(),et=!1,nt=o.find("li").first();h.outerHeight(!0)>dt&&g>3;)lt=nt.find(".app-event").data("data-context"),at=lt&&lt[b.Name],it&&(at==it||at==ei)?et=!0:(nt.remove(),g--,o.find("li").length==0&&(o.remove(),et?p--:d--)),et?(o=h.find("li.app-agenda-day-list").last(),nt=o.find("li").last()):(o=h.find("li.app-agenda-day-list").first(),nt=o.find("li").first());return[d,p]}for(ot in u)if(tt=u[ot],st=ot<0,tt.length<kt&&(l=i.find(".app-calendar-load-at-top"),y=i.find(".app-calendar-load-at-bottom"),st?l.hide():y.hide()),tt.length>0)for(gt in tt)bt(tt[gt],st);var ni=c.getBlocks(),ti=[],si=k.getFullYear();ni.each(function(){var f=$(this),r=f.attr("data-cal-year"),u=f.attr("data-cal-month"),e=r+"-"+u,n;if(ti[e])return!0;for(monthHeader=i.find(String.format('li.app-calendar-month-header[data-cal-year="{0}"][data-cal-month="{1}"]',r,u)),monthHeader.length||(monthHeader=$(String.format('<li class="app-calendar-month-header ui-btn" data-cal-year="{0}" data-cal-month="{1}"><h1>{2}<\/h1><\/li>',r,u,t.MonthNames[u])).insertBefore(f),r!=si&&monthHeader.find("h1").text(t.MonthNames[u]+" "+r)),n=f.prev();n.length;){if(n.attr("data-cal-year")!=r||n.attr("data-cal-month")!=u){monthHeader.insertBefore(n.next());break}n=n.prev()}ti[e]=!0});a.validateToday(h,ni,r);i.addClass("data-loaded");rt&&st&&n.scroll(ii,rt.position().top-fi)},validateToday:function(n,t,r){var f,v,h;if(!this.todayLoaded){var c=t.first(),y=c.length?i(c):r,l=t.last(),p=l.length?i(l):r,w=y<ot&&ot<p,u,s;if(w||g(r)){if(this.todayLoaded=!0,f=this.getDayList(n,ot,"search"),f.find(".app-time-line-container").length)return;var b=f.parents("li[data-cal-year]"),a=new Date,o=$('<li class="app-time-line-container"><\/li>').appendTo(f),k=$('<span class="app-event-time"><\/span>').text(e(a)).appendTo(o);for(timeLine=$('<div class="current-time-line"><div class="dot">&nbsp;<\/div><\/div>').appendTo(o),b.addClass("app-has-current-day"),u=o.prev();u.length;){if(v=u.find(".app-event"),h=v.data("data-context"),h&&h[this.calendar.activeCalendar.date.Name]>a)s=u;else break;u=u.prev()}s&&o.insertBefore(s)}}},removeData:function(n,t){n.find('.app-calendar-agenda-list li[data-cal-page="'+t+'"]').remove();t==this.maxPage?(n.find(".app-calendar-load-at-bottom .ui-btn").addClass("dv-load-at-bottom").text(l.Loading).show(),this.maxPage--):t==this.minPage&&(n.find(".app-calendar-load-at-top .ui-btn").addClass("dv-load-at-top").text(l.Loading).show(),this.minPage++);this.removeEmptyRows(n)},getDayList:function(n,r,u){var s=this.calendar.getBlockByDate(n,r),e,y,l,h;if(!s.length){var f=$('<li class="app-agenda-day-list"><\/li>').attr("data-cal-year",r.getFullYear()).attr("data-cal-month",r.getMonth()).attr("data-cal-day",r.getDate()),a=t.AbbreviatedDayNames[r.getDay()],p=$(String.format('<h2 class="ui-btn"><span class="app-calendar-daynumbig">{2}<\/span><span class="app-calendar-dayname">{0}<\/span> <span class="app-calendar-monthname">{1}<\/span> <span class="app-calendar-daynum">{2}<\/span><\/h2>',a,t.AbbreviatedMonthNames[r.getMonth()],r.getDate())).appendTo(f).attr("title",String.format("{0:"+t.LongDatePattern+"}",r)),v=$('<div class="app-calendar-day"><\/div>').appendTo(f),o=new Date,c=new Date;if(o.setDate(o.getDate()-1),c.setDate(o.getDate()+1),g(r)?f.addClass("app-calendar-agenda-today"):ai(r,o)?f.addClass("app-calendar-agenda-yesterday"):ai(r,c)&&f.addClass("app-calendar-agenda-tomorrow"),u=="prepend")f.prependTo(n);else if(u=="append")f.appendTo(n);else{for(e=n.find("li[data-cal-year]:first"),h=!1;e.length;){if(l=i(e),r<l){f.insertBefore(e);h=!0;break}y=e;e=e.next()}h||f.appendTo(n)}s=$("<ul><\/ul>").appendTo(v);d(f)}return s},removeEmptyRows:function(n){n.find(".app-calendar-agenda-list > li").each(function(){var t=$(this),e=t.is(".app-calendar-month-header"),r=i(t),u,f;e?(u=n.find(String.format('li[data-cal-year="{0}"][data-cal-month="{1}"][data-cal-day]',r.getFullYear(),r.getMonth())),u.length==0&&t.remove()):(f=t.find("ul .app-event"),f.length==0&&t.remove())})},getBlocks:function(){var n=this.calendar.scrollable();return n.find(".app-calendar-agendaview > .app-calendar-agenda-list > li:not(.app-calendar-month-header)")}};$app.touch.presenter("register",{name:"calendar",icon:function(){return"calendar"},text:function(){return u.Text},supports:wr,show:function(n){var t=$app.find(n.id);t&&t.calendar&&t.calendar.show(n)},hide:function(t){var i=n.dataView();i&&i.calendar&&i.calendar.hide(t)},dispose:function(t){var i=n.dataView();i&&i.calendar&&(i.calendar.dispose(t),delete i.calendar)}});f=n.CalendarInput=function(n,t){function d(){var a,n,h;if(u.tagged("calendar-input-disabled"))return!1;a=o.closest(".app-wrapper");n=c.find(".app-calendar-cover");i.length||(i=t.container=$('<div class="app-calendar-plugin-container app-data-input-helper"><\/div>').hide().appendTo(c),$('<div class="ui-btn ui-btn-icon-notext app-calendar-btn-close material-icon"><\/div>').appendTo(i).attr("title",s.ModalPopup.Close));n.length||(n=$('<div class="app-calendar-cover" style="display:none"><\/div>').appendTo(c));i.data("data-input",o);h=u.DataFormatString=="{0:t}"||u.DataFormatString=="{0:T}";t.showTime=!!(u.TimeFmtStr||h);t.hideDate=h;u.tagged("calendar-input-future")&&(t.limitStart=new Date,t.limitStart.setHours(0,0,0,0));nt(t.date)||(e&&e.length&&(t.date=l.convertStringToFieldValue(u,e.val())),nt(t.date)||(t.date=new Date));i.data("select-date",t.date);t.onselect=function(n){var t,r;n.date.setSeconds(0,0);t=n.target.closest(".app-month-container");t.length&&(w(t,n.date),t.find(".app-selected").removeClass("app-selected"),b(i,n.date).addClass("app-selected"),tt());i.data("select-date",n.date);i.find(".app-calendar-action-bar:visible").length||(r=n.dataView.findField(k),r&&(y(n.dataView,r,e,n.date),n.endField&&(!r.TimeFmtStr||n.oldTimeMode=="Minute"&&n.target.closest(".app-time-selector").length)&&setTimeout(function(){e.blur();$app.input.execute({dataView:l,values:[{name:n.endField,value:n.date}]});setTimeout(function(){a.find(String.format('[data-field="{0}"]',n.endField)).first().trigger("vclick")},10)},250)),n.mode||i.find(".app-time-container:visible").length||(f.ignoreShow=!0,p()))};t.onrefresh=function(n){n.monthContainer.find(".app-selected").removeClass("app-selected");var t=n.container.data("select-date")||n.date;nt(t)&&b(n.monthContainer,t).addClass("app-selected")};t.attachCallbacks=!0;e&&e.attr("data-datepicker-attached",!0);c.on("mousedown",v);r("attach",g(t))}function a(n){if(h&&!n)return $(".app-data-input").blur(),setTimeout(a,300,!0),!0;var k=o.closest(".app-wrapper"),b=c.find(".app-calendar-cover"),r,u,e=at.width(),s=at.height(),l=e<=480&&s<=480,y=h||l;t.date&&i.data("select-date",t.date);h&&e<s?i.removeClass("app-calendar-wide"):i.addClass("app-calendar-wide");var v=i.height(),w=i.width(),p=o.offset();return l||(u=p.left,u+w-e>0&&(u=e-w-10),h?(r=p.top-v,r<0&&(r=p.top+o.outerHeight(),r+v>s&&(l=y=!0))):(r=p.top+o.outerHeight(),r+v>s&&(r-=v+o.outerHeight(),r<0&&(l=y=!0)))),l&&(r=(s-v)/2,u=(e-w)/2),y?(h||(f.ignoreHide=!0,$(".app-data-input").blur()),i.addClass("app-calendar-show-bar"),b.show()):(b.hide(),i.removeClass("app-calendar-show-bar")),i.css({top:r,left:u}),i.show(),y}function v(n){var t=$(n.target);t.closest('.app-input-text, .app-calendar-plugin-container, [data-field="'+k+'"]').length||(c.off("mousedown",v),f("hide",{container:i}))}function y(n,t,i,r){var o=nt(r),u,e;o||t.AllowNulls||(r=new Date);h||!i||i.parent().length==0?($app.input.execute({dataView:n,values:[{name:t.Name,value:r}]}),h||setTimeout(function(){f.ignoreShow=!0;$app.input.focus({dataView:n,fieldName:t.Name})},50)):(u=t.format(r),e=i.data("placeholder"),i.val(u),h||i.focus()[0].setSelectionRange(u.length,u.length),e&&e.css("display","none"),i.closest("[data-control]").find(".app-control-inner").text(u).removeData("last-smart-text"))}function p(){f.ignoreHide?f.ignoreHide=!1:(i.hide(),$(".app-calendar-cover").hide(),c.off("mousedown",v),e&&e.select())}function g(n){var f,e,r,i,o;if(n.renderTime=!0,n.excludeKeyFieldsFromFilter=!0,n.queryData=function(n,t){return n&&n.tagged("calendar-input-data-none")?!1:n&&n.Name!=t||!n&&t?!1:!0},n.limitStart=!1,u)for(f=l.calendar&&l.calendar.calendars||yi(l),e=f.length,r=0;r<e;r++)i=f[r],i.end&&(u.Name==i.date.Name?t.endField=i.end.Name:u.Name==i.end.Name&&(t.startField=i.date.Name,o=l.editRow(),t.limitStart=new Date(o[i.date.Index]),t.limitStart.setHours(0,0,0,0)));return n}if(f.ignoreShow)return f.ignoreShow=!1,!1;t||(t={});t.container||(t.container=c.find(".app-calendar-plugin-container"));var e=t.input,i=t.container,o=t.inputContainer||i&&i.data("data-input")||e&&e.closest("[data-input]"),u=t.field=t.field||o&&$app.input.elementToField(o),l=t.dataView=t.dataView||u&&u._dataView,k=u&&u.Name,h=$app.touch.pointer()=="touch";switch(n){case"setInput":y(t.dataView,u,e,t.date);break;case"clear":y(t.dataView,u,e);break;case"hide":p();break;case"escape":p();t.container.is(".app-calendar-show-bar")&&(f.ignoreShow=!0,$app.input.focus({fieldName:t.field.Name}));break;case"focus":a();break;case"activate":return h||at.width()<=640&&at.height()<=640?(d(),a()):!1;case"attach":return d();default:return r(n,g(t))}};f.ignoreHide=!1;$(document).on("focus",".app-data-input[data-datepicker-attached]",function(n){var t=$(n.target);setTimeout(function(){f("focus",{input:t})},10)}).on("input",".app-data-input[data-datepicker-attached]",function(n){var r=$(n.target),t=$app.input.eventToField(n),e=t._dataView,i=eu(t,r.val()),u=c.find(".app-calendar-plugin-container");nt(i)&&(u.data("select-date",i),f("setDate",{input:r,date:i,dataView:e,container:u,showTime:!!t.TimeFmtStr}))}).on("remove.input.app",".app-data-input[data-datepicker-attached]",function(){f("hide")});r=function(r,f){function ii(){return a.calendar?a.calendar.activeCalendar:yi(a)[0]}function ri(n){return[t.MonthNames[n.getMonth()]+" "+n.getFullYearText(),t.AbbreviatedMonthNames[n.getMonth()]+" "+n.getFullYearText()]}function wt(){var n=i(c);return v.closest(".app-calendar-show-time").length&&lt(p,n),n}function ui(n,i,r){var e,u,h,o,f,s;for(n.empty(),e="<table><thead>",r&&(u=$("<div><\/div>").appendTo(n),h=ri(i),u.text(h[0]),u[0].scrollWidth>u.innerWidth()&&u.text(h[1])),o=0;o<7;o++){var c=ht[o],l=t.ShortestDayNames[c],a=t.DayNames[c];e+='<th title="'+a+'">'+l+"<\/th>"}e+="<\/thead><tbody>"+vr(i.getFullYear(),i.getMonth(),!0)+"<\/tbody><\/table>";f=$(e).appendTo(n);n.is(".app-first-month")||f.find("td.app-prev-month").addClass("app-day-hidden");n.is(".app-last-month")||f.find("td.app-next-month").addClass("app-day-hidden");f.find("tr").filter(function(){return!$(this).find("td:not(.app-day-hidden), th").length}).addClass("app-week-hidden");s=f.find("td.app-current-day");s.length&&s.html('<span class="app-current-day">'+s.text()+"<\/span>");w(n,i)}function bt(n,t,i){var r=/(\d+), (\d+)/;$(i).each(function(){var f=this[1],i=this[0],u;if(f&&f!=0&&(i.indexOf(", ")<0&&(i=i+", "+i),u=r.exec(i),u)){var e=parseInt(u[1],10)-1,o=u[2],s=new Date(t.getFullYear(),e,o),h=b(n,s);h.addClass("app-has-data").attr("title",String.format("{0} ({1})",y.Label,f))}})}function kt(n,i,r){var h=new Date(i),u,p,e,w;dt(n,h);var c=n.find(".app-hour-selector").hide(),l=n.find(".app-minute-selector").hide(),b=l.find("li"),o=fu(h),a=n.find(".app-time-hour"),v=n.find(".app-time-minute"),k=n.find(".app-time-ampm"),s=n.find(".app-time-hand").removeClass("app-inner-ring app-dot"),f=0,y=t.AMDesignator=="";a.text(o.hour);v.text(o.minute);n.find(".app-cal-selected").removeClass("app-cal-selected");switch(r){case"Hour":a.addClass("app-cal-selected");c.show();u=i.getHours();y?u<12&&s.addClass("app-inner-ring"):u>=12&&(u-=12);f=u*30;p=c.find("li");p.eq(u).addClass("app-cal-selected");break;case"Minute":v.addClass("app-cal-selected");l.show();e=i.getMinutes();f=e*6;e%5!=0?s.addClass("app-dot"):b.eq(e/5).addClass("app-cal-selected")}f>360&&(f-=360);s.css("transform","rotate("+f+"deg)");y||(w=k.find("span"),w.eq(o.ampm==t.AMDesignator?0:1).addClass("app-cal-selected"))}function ut(){function oi(n,t){return e.is(":visible")?vt.activePage.attr("id")!=ai?!0:f.queryData&&!f.queryData(n,t)?!0:!1:!0}var hi=c.find(".app-scroll-inner"),nt=c.find(".app-scroll-column > div"),u=i(nt.eq(tt)),it=wt(),ci=h.getMonth(),r=v.find(".app-calendar-plugin-header div"),vi=r.text(),li=$.mobile.activePage.find(".app-wrapper"),gt=li.find(".app-calendar"),yi=gt.length&&gt.is(":visible"),ti=l.find(".app-scroll-inner"),n=new Date(h),ii=f.reloadData,lt,ri,ut,at,s,yt,b;isNaN(u.getTime())&&(u=new Date(h),u.setMonth(u.getMonth()-tt,1));switch(k){case"":r.html(String.format(ar,t.MonthNames[h.getMonth()],h.getFullYearText(),t.MonthNames[h.getMonth()],h.getFullYearText()));lt=r.find("a");ri=lt.first().outerWidth()+lt.eq(2).outerWidth();ri>r.innerWidth()-60&&r.html(String.format(ar,t.MonthNames[n.getMonth()],h.getFullYearText(),t.AbbreviatedMonthNames[n.getMonth()],h.getFullYearText()));(h.getFullYear()!=u.getFullYear()||h.getMonth()!=u.getMonth())&&(ii=!0,n.setMonth(n.getMonth()-tt,1),nt.each(function(){var t=$(this);ui(t,n,!t.is(".app-first-month"));n.setMonth(n.getMonth()+1)}));ot||f.limitEnd?nt.each(function(){var t=$(this),n=i(t);t.find("td").filter(function(){var t=new Date(n),i=$(this);return(t.setMonth(i.closest("[data-cal-month]").attr("data-cal-month"),i.attr("data-cal-day")),i.is(".app-prev-month")?t.setMonth(n.getMonth()-1):i.is(".app-next-month")&&t.setMonth(n.getMonth()+1),ot&&t<ot)?!0:f.limitEnd&&t>f.limitEnd?!0:!1}).addClass("app-day-unselectable")}):nt.find(".app-day-unselectable").removeClass("app-day-unselectable");function fi(){hi.css("marginLeft","")}g&&g!=""?ni(l,c,null,fi):fi();setTimeout(function(){var n=c.height();n>0&&(c.height(n),l.height(n))});break;case"selectmonth":r.html(String.format('<a class="ui-btn app-year-picker">{0}<\/a>',n.getFullYearText()));n.setFullYear(n.getFullYear()-1);s=Math.floor(c.height()/3)-10;ut=function(){l.find(".app-scroll-column").each(function(){var r=$(this).empty(),i,u;for(w(r,n),i=0;i<12;i++)u=$(String.format('<div class="app-select-month ui-btn" data-cal-month="{0}" title="{2}">{1}<\/div>',i,t.AbbreviatedMonthNames[i],t.MonthNames[i])).css({height:s,lineHeight:s+"px"}).appendTo(r),it.getMonth()==i&&it.getFullYear()==n.getFullYear()&&u.addClass("app-selected");d(r);n.setFullYear(n.getFullYear()+1)});ti.css("marginLeft","")};g&&g!=""?g=="selectyear"?ni(l,l,ut):ut():ni(c,l,ut);break;case"selectyear":at=n.getFullYearText();n.setFullYear(n.getFullYear()-12);s=Math.floor(c.height()/3)-10;yt=function(){l.find(".app-scroll-column").each(function(){var t=$(this).empty(),r,i;for(w(t,n),i=0;i<12;i++)r=$(String.format('<div class="app-select-year ui-btn" data-cal-year="{0}">{1}<\/div>',n.getFullYear(),n.getFullYearText())).css({height:s,lineHeight:s+"px"}).appendTo(t),n.getFullYear()==it.getFullYear()&&r.addClass("app-selected"),n.setFullYear(n.getFullYear()+1);d(t)});ti.css("marginLeft",-v.width())};r.html(String.format('<a class="ui-btn app-year-range">{0} - {1}<\/span>',at,at+11));g!="selectyear"?ni(l,l,yt):yt()}st&&kt(p,h,rt);var ei=e.data("calendar-onrefresh"),ai=vt.activePage.attr("id"),pt=y&&y.Name;if(ei&&ei({container:e,monthContainer:c,selectorContainer:l,timeContainer:p,dataView:a,mode:k,date:it,startField:f.startField,endField:f.endField}),ii&&!f.hideDate&&!a._survey&&y.AllowQBE&&!(a._keyFields.length==1&&a._keyFields[0].Name=="sys_pk_")){var et=new Date(h.getFullYear(),h.getMonth()),si=String.format("{0}-{1}",et.getFullYear(),ci),ht=ft[y.Name],dt=c.find(".app-scroll-column").eq(1);dt.find(".app-has-data").removeClass("app-has-data").attr("title","");ht||(ht=ft[y.Name]={});b=ht[si];b?bt(dt,et,b):(clearTimeout(fr),fr=setTimeout(function(){if(!oi(y,pt)){var u=[pt],n=new Date(et),i=o[n.getDay()],t,r={},f=a._keyFields.map(function(n){return n.Name});i!=0&&n.setDate(n.getDate()-i);t=new Date(n);t.setDate(t.getDate()+7+35*tt);t.setSeconds(-1);r[y.Name]=["pivot-row1-month-raw","pivot-row2-day"];$app.execute({controller:a._controller,command:"Pivot",view:a._viewId,_filter:ct(a,y,null,n,t,f),fieldFilter:u,sort:"",pivotDefinitions:r,tags:a.get_tags(),success:function(n){var t=n.Pivots.pivot0;t&&(b=ht[si]=n.Pivots.pivot0.Data.slice(1),a.session("calendar-input-cache",ft),oi(y,pt)||bt(dt,et,b))},error:function(n){$app.alert(String.format("{0}",n.get_message()))}})}},300))}return v}function fi(){var ii=a.extension().commandRow(),ot=!v.length,pt,it,i,ft,nt;if(ot){v=$('<div class="app-calendar-plugin"><\/div>').prependTo(e);var ht=$('<div class="app-calendar-plugin-header"><div>&nbsp;<\/div><\/div>').appendTo(v),ri=$('<a href="#" class="app-calendar-plugin-loadleft ui-btn ui-btn-corner-all ui-btn-icon-notext ui-icon-carat-l"><\/a>').attr("title",s.Pager.Previous).prependTo(ht),ui=$('<a href="#" class="app-calendar-plugin-loadright ui-btn ui-btn-corner-all ui-btn-icon-notext ui-icon-carat-r"><\/a>').attr("title",s.Pager.Next).appendTo(ht),lt=new Date(h);c=$('<div class="app-month-container" data-draggable="calendar-mini"><\/div>').appendTo(v);var b=$('<div class="app-scroll-inner"><\/div>').appendTo(c),at=$('<div class="app-scroll-column"><\/div>').appendTo(b),vt=$('<div class="app-scroll-column"><\/div>').appendTo(b),yt=$('<div class="app-scroll-column"><\/div>').appendTo(b);if(l=$('<div class="app-date-selector-container" data-draggable="calendar-mini" style="display:none"><\/div').appendTo(v),pt=$('<div class="app-scroll-inner"><div class="app-scroll-column"><\/div><div class="app-scroll-column"><\/div><div class="app-scroll-column"><\/div><\/div>').appendTo(l),f.renderTime){p=$('<div class="app-time-container"><div class="app-time-header"><span class="app-time-hour app-cal-selected">12<\/span>:<span class="app-time-minute">00<\/span> <span class="app-time-ampm"><\/span><\/div> <div class="app-time-selector" data-draggable="calendar-mini-hand"><div class="app-hour-selector"><ul class="app-hour-list">'+(t.AMDesignator==""?"<li>00<\/li><li>1<\/li><li>2<\/li><li>3<\/li><li>4<\/li><li>5<\/li><li>6<\/li><li>7<\/li><li>8<\/li><li>9<\/li><li>10<\/li><li>11<\/li><li>12<\/li><li>13<\/li><li>14<\/li><li>15<\/li><li>16<\/li><li>17<\/li><li>18<\/li><li>19<\/li><li>20<\/li><li>21<\/li><li>22<\/li><li>23<\/li>":"<li>12<\/li><li>1<\/li><li>2<\/li><li>3<\/li><li>4<\/li><li>5<\/li><li>6<\/li><li>7<\/li><li>8<\/li><li>9<\/li><li>10<\/li><li>11<\/li>")+'<\/ul><\/div><div class="app-minute-selector" style="display: none"><ul class="app-minute-list"><li>00<\/li><li>05<\/li><li>10<\/li><li>15<\/li><li>20<\/li><li>25<\/li><li>30<\/li><li>35<\/li><li>40<\/li><li>45<\/li><li>50<\/li><li>55<\/li><\/ul><\/div><span class="app-time-hand app-transition"><span><\/span><\/span><\/div><\/div>').appendTo(e);var wt=p.find(".app-time-selector"),ct=p.find(".app-time-ampm"),r=wt.height()/2,g=r*.815,bt=t.AMDesignator==""?r*.55:g,kt=p.find(".app-hour-list li"),ni=p.find(".app-minute-list li"),ti=t.AMDesignator?12:24,o;for(i=0;i<ti;i++)o=i*30/57.2958-Math.PI/2,it=i>=12?g:bt,kt.eq(i).css({top:r+it*Math.sin(o),left:r+it*Math.cos(o)});for(i=0;i<12;i++)o=i*30/57.2958-Math.PI/2,ni.eq(i).css({top:r+g*Math.sin(o),left:r+g*Math.cos(o)});t.AMDesignator?ct.html("<span>"+t.AMDesignator+"<\/span><br/><span>"+t.PMDesignator+"<\/span>"):ct.hide();f.hideActionBar||(ft=['<a class="ui-btn ui-corner-all ui-mini ui-btn-inline app-calendar-btn-ok">'+s.ModalPopup.OkButton+"<\/a>",'<a class="ui-btn ui-corner-all ui-mini ui-btn-inline app-calendar-btn-cancel">'+s.ModalPopup.CancelButton+"<\/a>",'<a class="ui-btn ui-corner-all ui-mini ui-btn-inline app-calendar-btn-clear"/>'],n.settings("ui.actions.reverse")==!0&&ft.reverse(),gt=$('<div class="app-calendar-action-bar">'+ft.join("")+"<\/div>").appendTo(e))}h.setMonth(h.getMonth()-tt,1);nt=function(n){for(var i,t=0;t<tt;t++)i=$("<div><\/div>").appendTo(n),t==0&&i.addClass("app-first-month"),t==tt-1&&i.addClass("app-last-month"),h.setMonth(h.getMonth()+1)};nt(at);nt(vt);nt(yt);d(b);h=lt}return e.find(".app-calendar-btn-clear").text(y.AllowNulls?et.LookupClearAction:u.Today),st?e.addClass("app-calendar-show-time"):e.removeClass("app-calendar-show-time"),f.hideDate?e.addClass("app-calendar-hide-date"):e.removeClass("app-calendar-hide-date"),w(c,h),dt(p,h),(f.attachCallbacks||ot)&&(f.onrefresh&&e.data("calendar-onrefresh",f.onrefresh),f.onselect&&e.data("calendar-onselect",f.onselect),e.data("calendar-show-months",tt),k="",e.data("calendar-mode",k),rt="Hour",e.data("calendar-time-mode",rt)),f.reloadData=!0,ut(),v}function ei(){var n=f.date,t;if(k==""?(t=ti(c,n),w(c,n)):k=="selectmonth"?(t=l.find('.app-scroll-column[data-cal-year="'+n.getFullYear()+'"]'),w(l,n)):k=="selectyear"&&(t=l.find('.app-scroll-column .app-select-year[data-cal-year="'+n.getFullYear()+'"]').parent(),w(l,n)),t.length&&k==g){var r=t.closest(".app-scroll-inner"),u=t.position().left,i=parseInt(r.css("marginLeft"),10),e=i-u;Math.abs(e-i)<5?ut():r.stop().animate({marginLeft:i-u},ut)}else ut()}function oi(){var o=f.event,r=f.target,u=e.data("calendar-onselect"),n=f.date,t=r&&r.closest("td");t&&t.length&&(n=k==""?i(c):i(l),t&&n.setFullYear(parseInt(t.attr("data-cal-year"),10),parseInt(t.attr("data-cal-month"),10),parseInt(t.attr("data-cal-day"),10)),v.closest(".app-calendar-show-time").length&&lt(p,n));u?u({container:v,monthContainer:c,selectorContainer:l,target:r,event:o,dataView:a,mode:k,timeMode:rt,oldTimeMode:at,showTime:st,date:n,startField:f.startField,endField:f.endField}):r.closest(".app-month-container").length&&(c.find(".app-selected").removeClass("app-selected"),b(c,n).addClass("app-selected"));f.date=h=n;kt(p,n,rt)}function si(){a.session("calendar-input-cache",null);ft={};f.reloadData=!0;ut()}function hi(){a.session("calendar-input-cache",null);v.removeData();ft=null;e.remove()}var e=f.container,it;e.is(".app-calendar-plugin")&&(e=e.parent());var v=e.find(".app-calendar-plugin"),c=v.find(".app-month-container"),l=v.find(".app-date-selector-container"),p=e.find(".app-time-container"),gt=e.find(".app-calendar-action-bar"),g=e.data("calendar-mode"),k=f.mode!=undefined?f.mode:g||"",at=e.data("calendar-time-mode"),rt=f.timeMode||at||"Hour",tt=e.data("calendar-show-months")||f.months||1,a=f.dataView||n.dataView(),ft=a.session("calendar-input-cache")||{},yt=e.data("calendar-field"),y=f.field||yt||ii().date,pt=e.data("calendar-limit-start"),ot=f.limitStart===undefined?pt:f.limitStart,st=f.showTime,h=new Date(f.date);h&&nt(h)||(h=i(c),st&&lt(p,h));k!=g&&e.data("calendar-mode",k);rt!=at&&e.data("calendar-time-mode",rt);pt!=ot&&e.data("calendar-limit-start",ot);yt!=y&&e.data("calendar-field",y);f.months&&e.data("calendar-show-months",f.months);switch(r){case"attach":it=fi();break;case"destroy":it=hi();break;case"refresh":it=ut();break;case"setDate":it=ei();break;case"getDate":it=wt();break;case"click":it=oi();break;case"clearCache":it=si();break;default:$app.alert('Attempted to run CalendarControl("'+r+'").')}return it};tr=function(n,t){this.dataView=n;this.calendar=n.calendar;this.calendars=t};tr.prototype={attach:function(t){var e=this.dataView,c=this,y,f;if(this.calendar||(this.calendar=this.dataView.calendar),!e.get_isTagged("calendar-mini-disabled")){e.get_isTagged("calendar-mini-twomonths")&&(this.showMonths=2);var h=this.calendar?this.calendar.navigateDate||this.calendar.lastDate:null,l=e.calendar.activeCalendar||e.calendar.calendars[Object.keys(e.calendar.calendars)[0]],a=l.date,v=e.extension().commandRow();if(h=v?new Date(v[a.Index]):null,(!h||isNaN(h.getTime()))&&(h=new Date),y=t.find(".app-calendar-plugin").length>0,f=r("attach",{dataView:this.dataView,container:t.find(".ui-panel-inner"),date:h,months:this.showMonths,mode:"",hideActionBar:!0,onselect:function(t){var s=t.target,p=t.container,rt=t.monthContainer,ft=t.selectorContainer,et=t.event,l=t.dataView,ot=t.mode,f=t.date,k=s.closest("table"),h=s.closest("tr"),d=p.find("tr.app-selected"),g=p.find("td.app-selected"),w=h.hasClass("app-selected"),it=s.hasClass("app-selected"),b=$.mobile.activePage.find(".app-wrapper"),nt=b.find(".app-calendar"),a="",tt=nt.length&&nt.is(":visible"),v=l.calendar,e=s,i,y;if(tt){switch(v.mode){case"year":i="Month";e=k.find("tbody tr").filter(function(){return $(this).find("td.app-next-month, td.app-prev-month, th").length<7});break;case"month":w?(i="Week",e=h):(i="Month",e=k.find("tbody tr").filter(function(){return $(this).find("td.app-next-month, td.app-prev-month, th").length<7}));break;case"week":w?i="Day":(i="Week",e=h);break;case"day":it?(i="Week",e=h):i="Day";break;case"agenda":i="Agenda";v.animate=!0;v.enhancePrecision=!0}i=="Week"&&f.setDate(f.getDate()-o[f.getDay()])}else!g.length||s.is(".app-selected")?d.length&&w?a="=":(f.setDate(f.getDate()-o[f.getDay()]),y=new Date(f),y.setDate(f.getDate()+7),y.setSeconds(-1),a="$between$",e=h):a="=";d.add(g).removeClass("app-selected");e.addClass("ui-btn-active app-selected");setTimeout(function(){if(e.removeClass("ui-btn-active"),tt){if(l.calendar.navigateDate=new Date(f),i.toLowerCase()==v.mode)n.presenter("show",{id:l._id,name:"calendar",container:b});else{var t=ut(b.parent().find(".app-bar-header .app-bar-calendar"),u[i]);t&&t.trigger("vclick")}r("refresh",{container:p,dataView:l})}else c.filter(a,f,y)},oi)},onrefresh:function(n){var f=n.container,t=n.monthContainer,e=t.find(".app-scroll-column > div"),p=n.selectorContainer,r=n.dataView,w=n.mode,k=n.date,o=f.find(".app-calendar-plugin-fieldselector"),u=c.getActiveCalendar().date,v=u.Label,s=o.find(".app-icon"),h=r._filter,l=$.mobile.activePage.find(".app-wrapper"),a=l.find(".app-calendar"),y=a.length&&a.is(":visible"),d=r.calendar;o.find(".text").text(v);clearTimeout(hr);hr=setTimeout(function(){var a,v,o,n;if(s.css("opacity","0"),c.filtered=!1,y){if(f.is(":visible")){if(e.find(".app-selected").removeClass("app-selected"),a=r.calendar,v=a.getMostVisibleBlock(l),!v)return;if(o=i(v),n=ti(t,o),!n||!n.length)return;switch(a.mode){case"year":case"month":n.find("table tr").filter(function(){return $(this).find("td.app-next-month, td.app-prev-month, th").length<7}).addClass("app-selected");break;case"week":b(n,o).parent().addClass("app-selected");break;case"day":b(n,o).addClass("app-selected")}}}else e.find(".app-selected").removeClass("app-selected"),h.length&&$(h).each(function(){var o=this,i,l,n;if(o.startsWith(u.Name)){if(i=/(\w+):(=|\$between\$)(%js%"(\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}.\d{3}Z?)")/.exec(o),!i)return!1;s.css("opacity","1");c.filtered=!0;var f=r.convertStringToFieldValue(u,i[3]),a=ti(t,f),e=new Date(f),h=i[2]=="=";return(e.setDate(f.getDate()+(h?1:7)),e.setSeconds(-1),l=ti(t,e),!a.length&&!l.length)?!0:(n=b(t,f).add(b(t,e)),n&&n.length&&(h?n.addClass("app-selected"):n.parent().addClass("app-selected")),!1)}})},450)}}),f.addClass("app-show-request").removeClass("app-hide-request"),!y){var k=$('<a class="ui-btn ui-btn-icon-none app-has-droparrow app-calendar-plugin-fieldselector"><span class="app-icon material-icon" style="opacity:0">filter_list<\/span><span class="text">'+a.Label+"<\/span><\/a>").appendTo(f),p=$('<div class="app-calendar-color-legend"><p class="app-item-desc app-item-desc-before"><\/p><ol><\/ol><\/div>').attr("data-calendar-for",l.name).appendTo(f).hide(),w=$('<a class="ui-btn ui-btn-icon-none app-has-droparrow app-legend-toggle"><\/a>').appendTo(p),d=$('<p class="app-item-desc app-item-desc-after"><\/p>').appendTo(p);$('<span class="app-see-more"><\/span>').text(s.Mobile.More).appendTo(w);$('<span class="app-see-less"><\/span>').text(u.Less).appendTo(w);f.on("show.sidebar.app",function(){var n=f.find(".app-month-container");n.length&&n.find(".app-scroll-inner").css("marginLeft","")})}return f}},refresh:function(){r("refresh",{container:n.sidebar().find(".app-calendar-plugin"),dataView:this.dataView})},getActiveCalendar:function(){return this.calendar?this.calendar.activeCalendar:this.calendars[Object.keys(this.calendars)[0]]},clearCache:function(){r("clearCache",{container:n.sidebar().find(".app-calendar-plugin"),dataView:this.dataView})},filterWithoutField:function(n){var t=this.getActiveCalendar().date.Name;return n.filter(function(n){return!n.startsWith(t)}).join("")},filter:function(t,i,u){var e=this,f=e.dataView,o=e.getActiveCalendar().date,s;f.extension()._instructed=!1;e.filtering=!0;switch(t){case"=":f.applyFieldFilter(o.Index,"=",[i]);break;case"$between$":f.applyFieldFilter(o.Index,"$between",[i,u]);break;case"clear":f.removeFromFilter(o);f.sync()}e.filtering=!1;s=r("refresh",{container:n.sidebar().find(".ui-panel-inner"),dataView:this.dataView})}};$(document).on("vclick",".app-calendar-color-legend",function(t){var r=$(t.target),ut=n.sidebar(),g,it,o,s,y,rt;if(r.is(".app-calendar-color-legend ol li, .app-calendar-color-legend ol li span")){t=r.is(".app-event")?r:r.find(".app-event");var ft=n.dataView(),u=ft.calendar,c=u.activeCalendar.colorMap,et=c.getVisibleColors().map(function(n){return c.color(n)}),l=$("body"),p=t.attr("class").match(/app-event-color-(\d+)/),w=l.attr("class").match(/app-event-filter-color-(\d+)/),b=!0;if(p){var k=parseInt(p[1],10),d="app-event-filter-color-"+k,ot=l.is("."+d);if(w&&(g=parseInt(w[1],10),b=et.indexOf(g)!=-1),c.clearFilter(),!ot&&b){l.addClass("app-event-filter "+d);var i=u.scrollable(),f=u.getFirstVisibleBlock(i),st=u.getLastVisibleBlock(i),nt=i.position().top,ht=nt+i.height(),e,a,v=!1,tt=!1;do it=f.find(".app-event.app-event-color-"+k),it.each(function(){var n=$(this),t=n.offset().top;if(t<nt)(u.mode=="month"||!e||e.offset().top<t)&&(e=n);else return t+n.height()>ht?(a=n,v=!0,!1):(tt=!0,v=!0,!1)}),f=f.next();while(!v&&f!=st&&f.length);if(!tt&&(a||e)){o=a||e;switch(u.mode){case"day":case"week":y=o.data("data-context");y&&(rt=y[1],s=h(rt,"find"));break;case"month":case"agenda":s=i.scrollTop()+o.offset().top-i.position().top+(o.height()-i.height())/2}s!=null&&n.animatedScroll(i,s)}}}return!1}if(r.is(".app-legend-toggle, .app-see-more, .app-see-less"))return n.callWithFeedback(r,function(){ut.find(".app-calendar-color-legend").toggleClass("app-see-all")}),!1}).on("vclick",".app-calendar-plugin-fieldselector",function(f){var d=$(f.target),c=d,v=c.closest(".app-calendar-plugin-fieldselector"),e=n.dataView(),o=e.calendarPlugin,l=c.closest(".app-calendar-plugin"),nt=l.data("calendar-mode"),y=l.find(".app-month-container"),tt=l.find(".app-date-selector-container"),it=c.closest("table"),h=[],k,a;o.filtered&&h.push({text:et.ClearFilter,icon:"material-icon-clear",callback:function(){o.filter("clear")}},{});$(o.calendars).each(function(){var n=this,t=n.date,i=o.getActiveCalendar().date;h.push({text:t.Label,icon:t==i?"check":"",callback:function(){if(e.calendar.preventNavigate=!0,i!=t){e.removeFromFilter(i);o.calendar.activeCalendar.colorMap.clearFilter();o.calendar.activeCalendar=n;var r=e.viewProp("calendarConfig");r.activeCalendar=n.name;e.viewProp("calendarConfig",r);o.calendar.clear(!0);e.sync()}}})});h.push({},{text:u.Today,icon:"material-icon-event",callback:function(){r("setDate",{container:y.closest(".ui-panel-inner"),date:new Date,dataView:e,reloadData:!0})}});var p=$.mobile.activePage.find(".app-wrapper"),w=p.find(".app-calendar"),g=w.length&&w.is(":visible"),s,b=u.Sync;return g?(k=e.calendar.getMostVisibleBlock(p),s=i(k)):(a=e.extension().commandRow(),a&&(s=new Date(a[o.getActiveCalendar().date.Index]))),s&&!isNaN(s.getTime())&&(b=String.format("{0} {1}",t.MonthNames[s.getMonth()],s.getFullYearText()),h.push({text:b,icon:"recycle",callback:function(){r("setDate",{container:y.closest(".ui-panel-inner"),date:s,dataView:e})}})),n.callWithFeedback(v,function(){n.listPopup({anchor:v,iconPos:"left",items:h})}),!1}).on("touchmove",".app-calendar-plugin, .app-calendar-plugin-container",function(n){if($(n.target).closest("[data-draggable]").length==0)return n.preventDefault(),!1}).on("vclick mousedown",".app-calendar-plugin, .app-calendar-plugin-container",function(u){var b,c,nt,l,at,k;if(u.preventDefault(),v)return v=!1,!1;if(u.type=="mousedown")return!1;var it=$(u.target),e=it,h=n.dataView(),s=e.closest(".app-calendar-plugin").parent();s.length||(s=e.closest(".app-calendar-plugin-container"));var p=s.data("calendar-mode"),rt=s.find(".app-month-container"),vt=s.find(".app-date-selector-container"),w=s.find(".app-time-container"),ut=e.closest("table"),ft=s.data("calendar-show-months"),d=w.find(".app-time-selector"),a=d.find(".app-time-hand"),o;if(o=p==""?ut.length?i(ut.parent()):i(rt):i(vt),w.length&&lt(w,o),e.is("span.app-current-day")&&(it=e=e.closest("td")),e.is("td")){if(e.is(".app-day-unselectable"))return;if(rt.is(":animated"))return;r("click",{container:s,dataView:h,target:e,event:u})}else if(e.is(".app-calendar-plugin-loadleft,.app-calendar-plugin-loadright"))b=e.is(".app-calendar-plugin-loadleft"),p==""?(b?o.setMonth(o.getMonth()-ft,1):o.setMonth(o.getMonth()+ft,1),n.callWithFeedback(e,function(){r("setDate",{container:s,date:o,dataView:h})})):p=="selectmonth"?n.callWithFeedback(e,function(){o.setFullYear(o.getFullYear()+(b?-1:1));r("setDate",{container:s,date:o,dataView:h})}):p=="selectyear"&&n.callWithFeedback(e,function(){o.setFullYear(o.getFullYear()+(b?-12:12));r("setDate",{container:s,date:o,dataView:h})});else if(e.is(".app-month-picker"))n.callWithFeedback(e,function(){r("setDate",{container:s,date:o,mode:"selectmonth",dataView:h})});else if(e.is(".app-year-picker"))p!="selectyear"?(o.setFullYear(o.getFullYear()-5),n.callWithFeedback(e,function(){r("setDate",{container:s,date:o,mode:"selectyear",dataView:h})})):e.removeClass("ui-btn-active");else if(e.is(".app-select-month"))n.callWithFeedback(e,function(){o.setMonth(parseInt(e.attr("data-cal-month"),10));r("setDate",{container:s,date:o,mode:"",reloadData:!0,dataView:h})});else if(e.is(".app-select-year"))n.callWithFeedback(e,function(){o.setFullYear(parseInt(e.attr("data-cal-year"),10));r("setDate",{container:s,date:o,mode:"selectmonth",dataView:h})});else if(e.is(".app-time-hour"))n.callWithFeedback(e),a.removeClass("app-transition"),r("refresh",{container:s,timeMode:"Hour",showTime:!0,dataView:h}),setTimeout(function(){a.addClass("app-transition")}),tt();else if(e.is(".app-time-minute"))n.callWithFeedback(e),a.removeClass("app-transition"),r("refresh",{container:s,timeMode:"Minute",showTime:!0,dataView:h}),setTimeout(function(){a.addClass("app-transition")}),tt();else if(e.closest(".app-time-ampm").length)o=s.data("select-date")||o,c=o.getHours(),o.setHours(c+(c<12?12:-12)),dt(w,o),n.callWithFeedback(e),r("click",{container:s,dataView:h,target:e,event:u,date:o,showTime:!0}),tt();else if(e.closest(".app-time-selector").length){o=s.data("select-date")||o;var et=t.AMDesignator=="",ot=d.offset(),yt=s.data("calendar-time-mode"),g=d.height()/2,st=$app.touch.lastTouch()||{x:u.pageX,y:u.pageY},ht=st.x-(g+ot.left),ct=st.y-(g+ot.top),pt=et?Math.sqrt(Math.pow(ht,2)+Math.pow(ct,2)):0,y=Math.atan2(ct,ht)+Math.PI/2;if(y<0&&(y+=Math.PI*2),y/=Math.PI*2,isNaN(y)){console.log("angle is NaN");return}tt();switch(yt){case"Hour":c=Math.round(y*12);et?(nt=pt>g/1.5,nt&&(c+=12),c==24?c=12:c!=12||nt||(c=0)):(c==12&&(c=0),o.getHours()>=12&&(c+=12));o.setHours(c);dt(w,o);r("click",{container:s,dataView:h,target:e,event:u,date:o,showTime:!0,getDateFromInput:!0});a.one("transitionend",function(){a.removeClass("app-transition");r("click",{container:s,dataView:h,target:e,event:u,date:o,showTime:!0,timeMode:"Minute",getDateFromInput:!0});a.addClass("app-transition")});break;case"Minute":l=Math.round(y*60)%60;at=Math.abs(o.getMinutes()-l);at>=5&&(k=l%5,k>2?l+=5-k:l-=k);l>=60&&(l=0);o.setMinutes(l);r("click",{container:s,dataView:h,target:e,event:u,date:o,showTime:!0,getDateFromInput:!0})}}else e.is(".app-calendar-btn-ok")?(o=s.data("select-date"),n.callWithFeedback(e,function(){f("setInput",{dataView:h,container:s,date:o});f("hide",{container:s})})):e.is(".app-calendar-btn-cancel")?n.callWithFeedback(e,function(){f("hide",{container:s})}):e.is(".app-calendar-btn-clear")?n.callWithFeedback(e,function(){f("clear",{dataView:h,container:s});f("hide",{container:s})}):e.is(".app-calendar-btn-close")&&n.callWithFeedback(e,function(){f("hide",{container:s})});return!1}).on("touchstart mousedown pointerdown",".app-calendar-cover",function(n){return n.preventDefault(),f("hide"),!1}).on("beforeactivatedatetime.input.app beforeactivatedate.input.app","[data-input]",function(n){if(n.namespace=="app.input"){var t={inputContainer:$(n.target)};t.field=$app.input.elementToField(t.inputContainer);t.date=n.value.inputValueRaw;t.dataView=t.field._dataView;f("activate",t)&&n.preventDefault()}}).on("beforefocus.input.app",'[data-input][data-type="date"],[data-input][data-type="datetime"]',function(n){var t={input:n.inputElement};t.inputContainer=$(n.target);t.field=$app.input.elementToField(t.inputContainer);t.dataView=t.field._dataView;f("attach",t)}).on("cancel.input.app",'[data-input][data-type="date"],[data-input][data-type="datetime"]',function(n){$(".app-data-input-helper").is(":visible")&&($(".app-data-input-helper").hide(),n.preventDefault())}).on("help.input.app",'[data-input][data-type="date"],[data-input][data-type="datetime"]',function(n){$(".app-data-input-helper").show();n.preventDefault()});$app.dragMan["calendar-mini"]={start:function(n){n.dir=n.target.closest(".ui-panel").length?"horizontal":"all";this._startX=n.x;this._maxMargin=-n.target.width()*2;this._inner=n.target.find(".app-scroll-inner").stop();this._originalMarginLeft=parseInt(this._inner.css("margin-left")||0,10);this._cancelMarginLeft=this._originalMarginLeft;this._startTime=+new Date},move:function(n){var t=this._originalMarginLeft+n.x-this._startX;t<0&&t>this._maxMargin?this._inner.css("marginLeft",t):(this._startX=n.x,this._originalMarginLeft=parseInt(this._inner.css("margin-left")||0,10))},end:function(n){var e=new Date-this._startTime<200,o,s,u,f;if(e&&Math.abs(this._startX-n.x)<10){this._inner.css("margin-left",this._originalMarginLeft);return}var h=n.target.closest(".app-calendar-plugin"),t=h.parent(),c=t.data("calendar-mode"),l=t.hasClass("app-calendar-show-time");columns=this._inner.find(".app-scroll-column");columnIndex=0;e?n.swipeRight||(columnIndex=2):(o=columns.first().width(),s=-parseInt(this._inner.css("marginLeft"),10),columnIndex=Math.round(s/o));u=columns.eq(columnIndex);f=i(c==""?u.children(":first"):u);l&&lt(t.find(".app-time-container"),f);r("setDate",{container:t,date:f});v=!0;setTimeout(function(){v=!1},250)},cancel:function(){this._inner.animate({marginLeft:this._cancelMarginLeft})}};$app.dragMan["calendar-mini-hand"]={start:function(n){n.dir="all";this._startX=n.x;this._startY=n.y;n._timeSelector=n.target.closest(".app-time-selector");n._outerContainer=n._timeSelector.closest(".app-calendar-plugin-container");n._hand=n._timeSelector.find(".app-time-hand").removeClass("app-transition");n._timeSelectorPos=n._timeSelector.offset();n._timeMode=n._outerContainer.data("calendar-time-mode");n._height=n._timeSelector.height()/2;n._is24hour=t.AMDesignator=="";n._date=n._outerContainer.data("select-date");n._isPM=!n._is24hour&&n._date.getHours()>=12},move:function(n){var e=n.x-(n._height+n._timeSelectorPos.left),o=n.y-(n._height+n._timeSelectorPos.top),s=n._is24hour?Math.sqrt(Math.pow(e,2)+Math.pow(o,2)):0,i=Math.atan2(o,e)+Math.PI/2,t,f,u;i<0&&(i+=Math.PI*2);i/=Math.PI*2;switch(n._timeMode){case"Hour":t=Math.round(i*12);n._is24hour?(f=s>n._height/1.5,f&&(t+=12),t==24?t=12:t!=12||f||(t=0)):(t==12&&(t=0),n._isPM&&(t+=12));n._date.setHours(t);break;case"Minute":u=Math.round(i*60);u==60&&(u=0);n._date.setMinutes(u)}r("click",{container:n._outerContainer,date:n._date,target:n.target,showTime:!0})},end:function(n){n._hand.addClass("app-transition");tt()},cancel:function(n){n._hand.addClass("app-transition")}};ir=function(n,t,i){this.dataView=n;this.calendar=t;this.map=i;this.map||(this.map={});this.count=0;for(var r in this.map)this.map.hasOwnProperty(r)&&this.count++};ir.prototype={color:function(n){if(n==undefined||n==null)return 0;var t=this,i=this.map[n];return typeof i=="undefined"&&(i=this.map[n]=1+this.count%tu,this.count++,t.calendar.color&&(clearTimeout(sr),sr=setTimeout(function(){t.dataView.viewProp("calendarColorMap-"+t.calendar.color.Name,t.map);t.dataView.calendarPlugin.refresh(!1,!0)},1e3))),i},className:function(n){return"app-event-color-"+this.color(n)},load:function(t){var i=this;clearTimeout(or);or=setTimeout(function(){var h=n.sidebar(),r=h.find(".app-calendar-color-legend"),v=h.find("a.app-legend-toggle"),c=r.find("ol"),f=i.calendar,u=f?f.color:null,l,e,w,a;if(!f||!u||!h.is(":visible")){r.length&&i.hide();return}if(l=u.Label,e=0,t||c.is(":empty")||f.name!=r.attr("data-calendar-for")){var y=i.dataView.calendar.getFirstVisibleBlock(),o=i.getVisibleColors(),p=r.data("calendar-colors")||[];if(!y||!y.hasClass("data-loaded")&&i.dataView.calendar.mode!="agenda")return;if(o.length==p.length&&o.join("")==p.join(""))return;r.data("calendar-colors",o);c.empty();o.forEach(function(n){var r=i.className(n),f=n||s.Data.NullValueInForms,t,o;u.Items&&u.Items.forEach(function(t){if(t[0]==n)return f=t[1],!1});r&&(t=$("<li><\/li>").text(f),o=$('<span class="app-event">&nbsp;<\/span>').addClass(r).appendTo(t),e++>=lr&&t.addClass("app-hidden"),t.appendTo(c));w=n});r.attr("data-calendar-for",f.name);u.AliasName&&u.AliasName.length&&(a=i.dataView.findField(u.AliasName),a&&(l=a.Label));r.find(".app-item-desc").text(l);e<=lr?v.addClass("app-hidden"):v.removeClass("app-hidden");e!=0&&f.color?r.removeClass("app-hidden"):r.addClass("app-hidden");i.show()}},450)},show:function(){var i=n.sidebar();if(i.is(":visible")&&this.dataView.calendar.mode!="year"){var t=i.find(".app-calendar-color-legend"),r=this.dataView.calendar.scrollable(),u=r.find(".app-calendar"),f=!t.is(":visible");!t.is(".app-hidden")&&u.is(":visible")&&t.find("ol li").length?f&&t.show():this.hide()}},hide:function(){var t=n.sidebar(),i=t.find(".app-calendar-color-legend");i.hide()},getVisibleColors:function(){var f=[],r=this.dataView.calendar,h=r.scrollable(),n=r.getFirstVisibleBlock(h),p=r.getLastVisibleBlock(h),e=r.mode=="agenda",c=e?r.activeCalendar.color.AliasName||r.activeCalendar.color.Name:3,t,l,u,a,v,o,y,s;if(r.mode!="year")while(n&&n.length){if(t=n.data("calendar-colors"),!t&&(n.hasClass("data-loaded")||e)){if(t=[],l=i(n),e)a=n.find(".app-event"),a.each(function(){var i=$(this).data("data-context"),n=i[c];t.indexOf(n)==-1&&t.push(n)});else{u=r.cache.select(l);for(v in u){o=u[v].rows||u.rows;for(y in o)s=o[y][c],t.indexOf(s)==-1&&t.push(s);if(r.mode.match(/day|week/))break}}n.data("calendar-colors",t)}if(t&&t.forEach(function(n){f.indexOf(n)==-1&&f.push(n)}),n[0]==p[0])break;n=n.next()}return f.sort()},clearFilter:function(){for(var t=[],n=0;n<=23;n++)t.push("app-event-filter app-event-filter-color-"+n);$("body").removeClass(t.join(" "))}}}();